"use strict";function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}define("sys.core.Base",function(){return Class("sys.core.Base",function(attr){var _this=this;this.func("constructor",this.noop),attr("protected"),this.prop("env",config.env);var _assembly="";attr("readonly"),attr("protected"),this.prop("assembly",function(){if(!_assembly){var parts=_this._.name.split(".");parts.length>1&&(_assembly=parts[0]+"."+parts[1])}return _assembly}),attr("protected"),this.func("settings",function(key){var defaultValue=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(key.indexOf(":")!==-1)return settings(key,defaultValue);if(""===_this.assembly)throw"assembly must be defined.";return settings(_this.assembly+":"+key,defaultValue)}),attr("protected"),this.func("onError",function(err){console.log("Error in "+_this._.name+" ("+err.toString()+")"),config.env.isProd||console.log(""+err)}),attr("protected"),this.func("errorText",function(err,list){var errCode="default",errText="Unknown error. ("+err+")";return err&&("string"==typeof err||"number"==typeof err?(errCode=err.toString(),errText="Error: "+errCode):err.code?(errCode=err.code,errText="Error: "+err.desc):err.error&&(err.error.code?(errCode=err.error.code,errText="Error: "+err.desc):errCode=err.error)),list&&(list[errCode]?errText=list[errCode]:"default"!==errCode&&list.default&&(errText=list.default)),errText})})}),define("sys.core.ErrorInfo",function(){return Class("sys.core.ErrorInfo",function(attr){var _this=this;attr("sealed"),this.func("constructor",function(code,desc,details,raw){"string"==typeof code?_this.desc=code:(_this.raw=code,void 0!==_this.raw.status&&void 0!==_this.raw.statusText&&(_this.code=raw.status,_this.desc=raw.statusText)),details&&(_this.details=details),!config.env.isProd&&_this.raw&&(_this.stack=_this.raw.stack||_this.raw.responseText)}),this.prop("isServerError",config.env.isServer),this.prop("code",config.env.isServer?"server_error":"client_error"),this.prop("desc",""),this.prop("details",""),this.prop("raw",null),this.prop("stack","")})}),define("sys.core.app.App",[(!0)("[Base]"),(!0)("sys.core.app.IApp")],function(Base,IApp){return Class("sys.core.app.App",Base,[IApp],function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base){base(),_this.info=_this.settings(":app")}),attr("async"),this.func("start",this.noopAsync),this.func("navigate",this.noop),attr("readonly"),this.prop("info",{})})}),define("sys.core.app.Client",[(!0)("sys.core.app.App")],function(App){return Class("sys.core.app.Client",App,function(attr){attr("override"),this.func("navigate",function(base,url,returnUrlORisReplace){base();var currentHash=document.location.hash.replace("#","");"string"==typeof returnUrlORisReplace?(url+="?returnUrl="+returnUrlORisReplace,"#"===url.substr(0,1)&&(url=url.substr(1)),document.location.replace("#"+url)):"boolean"==typeof returnUrlORisReplace&&returnUrlORisReplace?("#"===url.substr(0,1)&&(url=url.substr(1)),document.location.replace("#"+url)):document.location.hash=url,currentHash===url&&window.dispatchEvent(new HashChangeEvent("hashchange"))})})}),define("sys.core.app.IApp",function(){return Interface("sys.core.app.IApp",function(){this.func("start"),this.func("navigate"),this.prop("info")})}),define("sys.core.app.Server",[(!0)("sys.core.app.App")],function(App){return Class("sys.core.app.Server",App,function(attr){attr("override"),this.func("navigate",function(base,url){base()})})}),define("sys.core.boot.Client",[(!0)("[Base]"),(!0)("[IBootware]"),(!0)("[App]"),(!0)("sys.core.app.IApp")],function(Base,IBootware,ClientApp,IApp){return Class("sys.core.boot.Client",Base,[IBootware],function(attr){var _this=this;attr("override"),attr("sealed"),this.func("constructor",function(base){if(base(),_this.bootwares=_this.settings("bootwares",[]).slice(),_this.bootwares.length>0){var i=0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=_this.bootwares[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;_this.bootwares[i]=(!0)(item),i++}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}),attr("private"),this.prop("bootwares",[]),attr("async"),this.func("boot",function(resolve,reject){include(_this.bootwares,!0).then(function(items){forAsync(items,function(_resolve,_reject,Bootware){if(Bootware&&"function"==typeof Bootware){var bootware=as(new Bootware,IBootware);bootware?bootware.boot().then(_resolve).catch(_reject):_resolve()}else _resolve()}).then(function(){resolve()}).catch(reject)}).catch(reject)}),attr("async"),this.func("ready",function(resolve,reject){return App=as(new ClientApp,IApp),App?void include(_this.bootwares,!0).then(function(items){forAsync(items,function(_resolve,_reject,Bootware){if(Bootware&&"function"==typeof Bootware){var bootware=as(new Bootware,IBootware);bootware?bootware.ready().then(_resolve).catch(_reject):_resolve()}else _resolve()}).then(function(){_this.env.isReady=!0,console.log(_this.env.isProd?"ready: (client, production)":"ready: (client, dev)"),_this.env.isTest?resolve():App.start().then(function(){console.log(App.info.title+" - "+App.info.version);var url=document.location.hash.replace("#","")||"/";App.navigate(url),resolve()}).catch(reject)}).catch(reject)}).catch(reject):void reject("Invalid app definition.")})})}),define("sys.core.boot.IBootware",function(){return Interface("sys.core.boot.IBootware",function(){this.func("boot"),this.func("ready")})}),define("sys.core.boot.Server",[(!0)("[Base]"),(!0)("[IBootware]"),(!0)("[App]"),(!0)("sys.core.app.IApp"),(!0)("express"),(!0)("fs")],function(Base,IBootware,ServerApp,IApp,express,fs){return Class("sys.core.boot.Server",Base,[IBootware],function(attr){var _this=this;attr("override"),attr("sealed"),this.func("constructor",function(base){if(base(),_this.app=express(),_this.bootwares=_this.settings("bootwares",[]).slice(),_this.bootwares.length>0){var i=0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=_this.bootwares[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;_this.bootwares[i]=(!0)(item),i++}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}),attr("private"),this.prop("app",null),attr("private"),this.prop("server",null),attr("private"),this.prop("bootwares",[]),attr("async"),this.func("boot",function(resolve,reject){_this.app.use(function(req,res,next){var responseHeaders=_this.settings("response.headers",[]),_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=responseHeaders[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var header=_step2.value;res.header(header.name,header.value)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}next()});var appSettings=_this.settings("express",{});for(var appSetting in appSettings)appSettings.hasOwnProperty(appSetting)&&_this.app.set(appSetting,appSettings[appSetting]);_this.env.isProd?_this.app.set("env","production"):_this.app.set("env","development"),include(_this.bootwares,!0).then(function(items){forAsync(items,function(_resolve,_reject,Bootware){if(Bootware&&"function"==typeof Bootware){var bootware=as(new Bootware,IBootware);bootware?bootware.boot(_this.app).then(_resolve).catch(_reject):_resolve()}else _resolve()}).then(function(){if(_this.env.isProd){var privateKey=fs.readFileSync(_this.settings("ssl.private"),"utf8"),certificate=fs.readFileSync(_this.settings("ssl.public"),"utf8"),credentials={key:privateKey,cert:certificate},https=require("https"),_port=_this.settings("port.prod",443);_this.app.set("port",_port),_this.server=https.createServer(credentials,_this.app)}else{var http=require("http"),port=_this.settings("port.dev",80);_this.app.set("port",port),_this.server=http.createServer(_this.app)}resolve()}).catch(reject)}).catch(reject)}),attr("async"),this.func("ready",function(resolve,reject){_this.server.on("error",_this.onError),_this.server.on("listening",function(){return App=as(new ServerApp(_this.app),IApp),App?void include(_this.bootwares,!0).then(function(items){forAsync(items,function(_resolve,_reject,Bootware){if(Bootware&&"function"==typeof Bootwate){var bootware=as(new Bootware,IBootware);bootware?bootware.ready(_this.app).then(_resolve).catch(_reject):_resolve()}else _resolve()}).then(function(){_this.env.isReady=!0,console.log(_this.env.isProd?"ready: (server, production)":"ready: (server, dev)"),_this.env.isTest?resolve():App.start().then(function(){console.log(App.info.title+" - "+App.info.version),App.navigate("/"),resolve()}).catch(reject)}).catch(reject)}).catch(reject):void reject("Invalid app definition.")}),_this.server.listen(_this.app.get("port"))})})}),define("sys.core.bootwares.Attributes",[(!0)("[Base]"),(!0)("[IBootware]"),(!0)("[Auth]"),(!0)("sys.core.comm.ClientResponse")],function(Base,IBootware,Auth,FetchResponse){return Class("sys.core.bootwares.Attributes",Base,[IBootware],function(attr){attr("async"),this.func("boot",function(resolve,reject,app){Container.register(Class("service",Attribute,function(){var _this=this;this.decorator(function(obj,type,name,descriptor){if(["func"].indexOf(type)===-1)throw"service attribute cannot be applied on "+type+" members. ("+name+")";if(["_constructor","_dispose"].indexOf(type)!==-1)throw"service attribute cannot be applied on special function. ("+name+")";var fetchUrl=_this.args[0]||"",staticOpts=_this.args[1]||{},fn=descriptor.value,fnArgs=null,inputArgs={},enableCookies=staticOpts.enableCookies||!1,responseDataType=staticOpts.responseDataType||null,requestDataType=staticOpts.requestDataType||null,auth=staticOpts.auth||null;staticOpts.responseDataType&&delete staticOpts.responseDataType,staticOpts.requestDataType&&delete staticOpts.requestDataType,staticOpts.auth&&delete staticOpts.auth,staticOpts.enableCookies&&delete staticOpts.enableCookies,descriptor.value=function(urlFillsOrInputData,inputData){var _this2=this;return _fetchUrl=fetchUrl,_fetchUrl.indexOf("/:")===-1?inputArgs.body=urlFillsOrInputData:(inputArgs.urlFills=urlFillsOrInputData,inputArgs.body=inputData),new Promise(function(resolve,reject){var doFetch=function(){var updatedBody=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return new Promise(function(_resolve,_reject){var onFetch=function(err,response,data){var _response=new FetchResponse(response,err,data);err?_reject(_response):_resolve(_response)};if(inputArgs.urlFills)for(var fill in inputArgs.urlFills)inputArgs.urlFills.hasOwnProperty(fill)&&(_fetchUrl=_fetchUrl.replace("/:"+fill,encodeURIComponent("/"+inputArgs.urlFills[fill].toString())));if(updatedBody&&(inputArgs.body=updatedBody),_fetchUrl){if(inputArgs.body&&(requestDataType&&(staticOpts.headers&&staticOpts.headers["Content-Type"]||(staticOpts.headers=staticOpts.headers||{},staticOpts.headers["Content-Type"]=requestDataType)),staticOpts.headers&&staticOpts.headers["Content-Type"]&&staticOpts.headers["Content-Type"].indexOf("json")!==-1?staticOpts.body=JSON.stringify(inputArgs.body):staticOpts.body=inputArgs.body),enableCookies?(staticOpts.headers=staticOpts.headers||{},"all"===enableCookies?staticOpts.headers.credentials="include":staticOpts.headers.credentials="same-origin"):(staticOpts.headers=staticOpts.headers||{},staticOpts.headers.credentials="omit"),staticOpts.headers=staticOpts.headers||{},staticOpts.headers.userLocale=_this2.env.getLocale(),auth){var applyHeaders=function(authHeaders){for(var authHeader in authHeaders)authHeaders.hasOwnProperty(authHeader)&&(staticOpts.headers=staticOpts.headers||{},staticOpts.headers[authHeader]=authHeaders[authHeader])};if("function"==typeof auth)auth(name).then(function(authHeaders){applyHeaders(authHeaders)}).catch(function(err){onFetch(err,null,null)});else if("string"==typeof auth&&"auto"===auth)if(_this2.env.isServer)onFetch("invalid auth settings for server.",null,null);else{var _auth=new Auth;applyHeaders(_auth.getTokenHeader())}else onFetch("invalid auth settings.",null,null)}}else onFetch("invalid fetch url",null,null);fetch(_fetchUrl,staticOpts).then(function(response){if(response.ok)switch(responseDataType){case"json":response.json().then(function(data){onFetch(null,response,data)}).catch(function(err){onFetch(err,response,null)});break;case"blob":response.blob().then(function(data){onFetch(null,response,data)}).catch(function(err){onFetch(err,response,null)});break;case"buffer":response.arrayBuffer().then(function(data){onFetch(null,response,data)}).catch(function(err){onFetch(err,response,null)});break;case"formData":response.formData().then(function(data){onFetch(null,response,data)}).catch(function(err){onFetch(err,response,null)});break;case"objectUrl":response.blob().then(function(data){onFetch(null,response,URL.createObjectURL(data))}).catch(function(err){onFetch(err,response,null)});break;case"text":default:response.text().then(function(data){onFetch(null,response,data)}).catch(function(err){onFetch(err,response,null)})}else onFetch(response.status,response,null)}).catch(function(err){onFetch(err,null,null)})})};doFetch.updateUrl=function(urlFills){inputArgs.urlFills=urlFills},doFetch.updateData=function(updatedBody){inputArgs.body=updatedBody},fnArgs=[doFetch,resolve,reject,inputArgs.body],fn.apply(void 0,_toConsumableArray(fnArgs))})}.bind(obj)})})),Container.register(Class("claims",Attribute,function(){var _this3=this;this.decorator(function(obj,type,name,descriptor){if(["func"].indexOf(type)===-1)throw"claims attribute cannot be applied on "+type+" members. ("+name+")";if(["_constructor","_dispose"].indexOf(type)!==-1)throw"claims attribute cannot be applied on special function. ("+name+")";var fn=descriptor.value,claims=_this3.args||null,fnArgs=null;descriptor.value=function(resolve,reject,request){var _this4=this,onAuth=function(){fnArgs=[resolve,reject,request],fn.apply(void 0,_toConsumableArray(fnArgs))};if(claims){request.claims=claims;var auth=new Auth;auth.validate(request).then(onAuth).catch(function(err){if(_this4.env.isServer)console.log("Failed to authenticate "+request.url+". ("+err+")"),request.response.send.error(401,err);else{console.log("Failed to authenticate "+document.location.hash+". ("+err+")");var loginUrl=settings("sys.core:view.login");App.navigate(loginUrl,document.location.hash)}})}else onAuth()}.bind(obj)})})),resolve()}),attr("async"),this.func("ready",this.noopAsync)})}),define("sys.core.bootwares.ErrorHandler",[(!0)("[Base]"),(!0)("[IBootware]"),(!0)("[ErrorInfo]")],function(Base,IBootware,ErrorInfo){return Class("sys.core.bootwares.ErrorHandler",Base,[IBootware],function(attr){var _this=this;attr("async"),this.func("boot",function(resolve,reject,app){_this.env.isServer&&(app.use(function(req,res,next){var err=new Error("Not Found: "+req.url);err.status=404,next(err)}),_this.env.isProd?app.use(function(err,req,res,next){res.status(err.status||500),err.stack="",next(err)}):app.use(function(err,req,res,next){res.status(err.status||500),next(err)})),resolve()}),attr("async"),this.func("ready",function(resolve,reject){_this.env.isServer||(window.onerror=function(desc,url,line,col,err){this.onError(new ErrorInfo("fatal_error",desc+" at: "+url+", "+line+":"+col,"",err))},require.onError=function(err){this.onError(new ErrorInfo(err))}),resolve()})})}),define("sys.core.bootwares.Router",[(!0)("[Base]"),(!0)("[IBootware]"),(!0)(" | sys/core/libs/pathparser{.min}.js"),(!0)("sys.core.comm.ServerRequest | sys.core.comm.ClientRequest"),(!0)("sys.core.comm.Handler")],function(Base,IBootware,RouteManager,Request,Handler){return Class("sys.core.bootwares.Router",Base,[IBootware],function(attr){var _this=this;attr("async"),this.func("boot",function(resolve,reject,app){var routesOrder=[],routes=[],router=_this.env.isServer?app:new RouteManager({}),fullUrl="",mainModule=_this.settings(":main","sample"),routesKey=_this.env.isServer?":routes.server":":routes.client";routesOrder=_this.settings(routesKey),routesOrder.unshift(_this.env.isServer?"app."+mainModule:"web."+mainModule),routesOrder.unshift(_this.assembly);var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=routesOrder[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var routesOf=_step.value;_this.env.isDev&&console.log("routes of: "+routesOf),routes=_this.settings(routesOf+routesKey,[]);var _loop=function(route){if(!route.url||!route.class)throw"Invalid route definiton: "+fullUrl;if(fullUrl=(route.root||"")+route.url,fullUrl=fullUrl.replace("//","/"),_this.env.isServer){if(!route.func||!route.verb)throw"Invalid route definiton: "+fullUrl+"#"+route.verb;if(["get","post","put","delete"].indexOf(route.verb)===-1)throw"Unknown verb for: "+route.url;router[route.verb](fullUrl,function(req,res){try{var handler=new Handler(route.class,route.func),request=new Request(handler,route.verb,req,res);handler.handle(request)}catch(err){console.log("Error handling "+fullUrl+". \n "+err),res.status(500).end()}}),_this.env.isDev&&console.log("  "+route.verb+": "+fullUrl)}else router.add(fullUrl,function(){var handler=new Handler(route.class,"navigate"),request=new Request(handler,route.url,this);try{handler.handle(request)}catch(err){throw console.log("Error handling "+fullUrl+". \n "+err),err}}),_this.env.isDev&&console.log("  navigate: "+fullUrl)},_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=routes[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var route=_step2.value;_loop(route)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}_this.env.isServer||(window.onhashchange=function(){var url=window.location.hash;"#"===url.substr(0,1)&&(url=url.substr(1)),router.run(url)}),resolve()}),attr("async"),this.func("ready",this.noopAsync)})}),define("sys.core.comm.ClientRequest",[(!0)("sys.core.comm.Request")],function(Request){return Class("sys.core.comm.ClientRequest",Request,function(attr){var _this=this;attr("override"),attr("sealed"),this.func("constructor",function(base,handler,url,args){base(handler,url,args);var fullUrl=document.location.hash;fullUrl.indexOf("?")!==-1&&(_this.query=_this.env.queryStringToObject(fullUrl.split("?")[1]))})})}),define("sys.core.comm.ClientResponse",[(!0)("sys.core.comm.Response")],function(Response){return Class("sys.core.comm.ClientResponse",Response,function(attr){var _this=this;attr("override"),attr("sealed"),this.func("constructor",function(base,res,err,data){base(res),_this.error=err||null,_this.data=data,_this.isError=!!err,_this.isRedirected=!!res&&res.redirected,_this.status=res?res.status:err,_this.statusText=res?res.statusText:err}),attr("readonly"),this.prop("isError",!1),attr("readonly"),this.prop("isRedirected",!1),attr("readonly"),this.prop("status",null),attr("readonly"),this.prop("statusText",""),attr("readonly"),this.prop("error",null),attr("readonly"),this.prop("data",null),this.func("getHeader",function(name){_this.res.headers.get(name)}),this.func("getContentType",function(){_this.getHeader("Content-Type")})})}),define("sys.core.comm.Handler",[(!0)("[Base]")],function(Base){return Class("sys.core.comm.Handler",Base,function(attr){var _this=this;attr("override"),attr("sealed"),this.func("constructor",function(base,className,funcName){base(),_this.className=className,_this.funcName=funcName}),attr("private"),this.prop("className",null),attr("private"),this.prop("funcName",null),this.func("handle",function(request){var errorText=_this.env.isServer?"Error handling: "+request.url+" (%ERROR%)":"Error handling: "+request.url+"#"+request.verb;include([(!0)(_this.className)]).then(function(Handler){var handler=new Handler,handlerInfo=Reflector.get(handler);handlerInfo.getMember(_this.funcName);_this.env.set("currentRequest",request),handler[_this.funcName](request).then(function(result){_this.env.reset("currentRequest")}).catch(function(err){_this.env.reset("currentRequest"),console.log(errorText.replace("%ERROR%",_this.errorText(err)))})}).catch(function(err){console.log(errorText.replace("%ERROR%",_this.errorText(err)))})})})}),define("sys.core.comm.Request",[(!0)("[Base]")],function(Base){return Class("sys.core.comm.Request",Base,function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base,handler,url,args){base(),_this.handler=handler,_this.url=url,_this.args=args}),attr("readonly"),this.prop("handler",null),attr("readonly"),this.prop("url",""),attr("readonly"),this.prop("args",null),attr("readonly"),attr("once"),this.prop("user",null),attr("readonly"),attr("once"),this.prop("claims",null),attr("readonly"),attr("once"),this.prop("query",null)})}),define("sys.core.comm.Response",[(!0)("[Base]")],function(Base){return Class("sys.core.comm.Response",Base,function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base,res){base(),_this.res=res}),attr("protected"),this.prop("res",null)})}),define("sys.core.comm.ServerRequest",[(!0)("sys.core.comm.Request"),(!0)("sys.core.comm.ServerResponse")],function(Request,Response){return Class("sys.core.comm.ServerRequest",Request,function(attr){var _this=this;attr("override"),attr("sealed"),this.func("constructor",function(base,handler,verb,req,res){base(handler,req.originalUrl,req.params),_this.verb=verb,_this.req=req,_this.res=res,_this.response=new Response(res),_this.data=req.body,_this.isSecure=req.secure,_this.isFresh=req.fresh,_this.query=_this.env.queryStringToObject(req.query)}),attr("private"),this.prop("verb",""),attr("private"),this.prop("req",null),attr("private"),this.prop("res",null),attr("readonly"),this.prop("response",null),attr("readonly"),this.prop("data",null),attr("readonly"),this.prop("isSecure",!1),attr("readonly"),this.prop("isFresh",!1),this.func("getLocale",function(){return _this.getHeader("userLocale")}),this.func("getToken",function(){return _this.req.token||null}),this.func("getHeader",function(){var _req;return(_req=_this.req).get.apply(_req,arguments)}),this.func("getCookie",function(name,isSigned){return isSigned?_this.req.signedCookies[name]:_this.req.cookies[name]}),this.func("isContentType",function(){var _req2;return(_req2=_this.req).is.apply(_req2,arguments)}),this.func("accepts",function(){var _req3;return(_req3=_this.req).accepts.apply(_req3,arguments)}),this.func("acceptsCharsets",function(){var _req4;return(_req4=_this.req).acceptsCharsets.apply(_req4,arguments)}),this.func("acceptsEncodings",function(){var _req5;return(_req5=_this.req).acceptsEncodings.apply(_req5,arguments)}),this.func("acceptsLanguages",function(){var _req6;return(_req6=_this.req).acceptsLanguages.apply(_req6,arguments)})})}),define("sys.core.comm.ServerResponse",[(!0)("sys.core.comm.Response")],function(Response){return Class("sys.core.comm.ServerResponse",Response,function(attr){var _this=this;attr("override"),attr("sealed"),this.func("constructor",function(base,res){base(res)}),attr("readonly"),this.prop("send",{json:function(_json){function json(_x){return _json.apply(this,arguments)}return json.toString=function(){return _json.toString()},json}(function(json){var status=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;config.env.isDev&&console.log(json),_this.res.status(status).json(json)}),data:function(_data){var status=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;config.env.isDev&&console.log(json),_this.res.status(status).send(_data)},file:function(fileName){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(resolve,reject){_this.res.sendFile(fileName,options,function(err){err?reject(err):resolve()})})},download:function(fileName,displayName){return new Promise(function(resolve,reject){_this.res.download(fileName,displayName,function(err){err?reject(err):resolve()})})},jsonp:function(json){var status=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200,callbackName=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";callbackName&&_this.res.app.set("jsonp callback name",callbackName),_this.res.status(status).jsonp(json),callbackName&&_this.res.app.set("jsonp callback name","")},redirect:function(path,status){status?_this.res.redirect(status,path):_this.res.redirect(path)},error:function(status,message){console.log(status+": "+message),_this.res.status(status).send(message)},none:function(status){status?_this.res.status(status).end():_this.res.end()}}),attr("readonly"),this.prop("isHeadersSent",function(){return _this.res.headersSent}),this.func("setHeader",function(){var _res;(_res=_this.res).append.apply(_res,arguments)}),this.func("setCookie",function(){var _res2;(_res2=_this.res).cookie.apply(_res2,arguments)}),this.func("clearCookie",function(){var _res3;(_res3=_this.res).clearCookie.apply(_res3,arguments)}),this.func("setContentType",function(){var _res4;(_res4=_this.res).type.apply(_res4,arguments)}),this.func("setLocal",function(name,value){_this.res.locals[name]=value}),this.func("getLocal",function(name,defaultValue){return _this.res.locals[name]||defaultValue})})}),define("sys.core.comm.Service",[(!0)("[Base]")],function(Base){return Class("sys.core.comm.Service",Base,function(attr){})}),define("sys.core.data.Automapper",[(!0)("[Base]")],function(Base){return Class("sys.core.data.Automapper",Base,function(attr){var _this=this;attr("override"),this.func("constructor",function(base){base();var currentRequest=_this.env.currentRequest();_this.vars.$loginId=currentRequest&&currentRequest.user?currentRequest.user.loginId:"",_this.vars.$clientId=currentRequest&&currentRequest.user?currentRequest.user.clientId:"",_this.vars.$locale=_this.env.getLocale().name,_this.vars.$lcId=_this.env.getLocale().lcId}),attr("once"),this.prop("config",{}),attr("private"),this.prop("vars",{}),attr("private"),this.func("resolveObjectProp",function(key){var prop="",cfg=_this.config[key];if(cfg)if("-"===cfg)prop=key;else{if(cfg.indexOf(".")!==-1&&cfg.indexOf("$")!==-1)for(var _var in _this.vars)_this.vars.hasOwnProperty(_var)&&(cfg=cfg.replace(_var,_this.vars[_var]));prop=cfg}return prop}),this.func("to",function(toEntity,fromObject){for(var key in _this.config)if(_this.config.hasOwnProperty(key)){var e={direction:"o2e",entity:{prop:key,value:null},object:{prop:_this.resolveObjectProp(key),value:null}};e.entity.value=toEntity[e.entity.prop],e.object.value=getNestedKeyValue(fromObject,e.object.prop,null),e.object.prop&&("function"==typeof _this.onMap&&_this.onMap(e),setNestedKeyValue(toEntity,e.entity.prop,e.object.value))}}),this.func("from",function(fromEntity,toObject){for(var key in _this.config)if(_this.config.hasOwnProperty(key)){var e={direction:"e2o",entity:{prop:key,value:null},object:{prop:_this.resolveObjectProp(key),value:null}};e.entity.value=fromEntity[e.entity.prop],e.object.value=getNestedKeyValue(toObject,e.object.prop,null),e.object.prop&&("function"==typeof _this.onMap&&_this.onMap(e),setNestedKeyValue(toObject,e.object.prop,e.entity.value))}}),this.prop("onMap")})}),define("sys.core.data.Repository",[(!0)("[Base]"),(!0)("[Automapper]")],function(Base,Automapper){return Class("sys.core.data.Repository",Base,function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base,dbContext){base(),_this.dbContext=dbContext,_this.automapper=new Automapper}),attr("protected"),this.prop("dbContext"),attr("protected"),this.prop("automapper"),this.func("toEntity",function(Entity,dbObject){var entity=new Entity;return _this.automapper.to(entity,dbObject),entity}),this.func("toEntityList",function(Entity,dbObjects){var entities=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=dbObjects[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var dbObject=_step.value;entities.push(_this.toEntity(Entity,dbObject))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return entities}),this.func("fromEntity",function(entity){var object={};return _this.automapper.from(entity,object),object}),this.func("fromEntityList",function(entities){var dbObjects=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=entities[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var entity=_step2.value;dbObjects.push(_this.fromEntity(entity))}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return dbObjects})})}),define("sys.core.data.UnitOfWork",[(!0)("[Base]")],function(Base){return Class("sys.core.data.UnitOfWork",Base,function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base,dbContext){base(),_this.dbContext=dbContext}),attr("protected"),this.prop("dbContext")})}),define("sys.core.db.DbContext",[(!0)("[Base]")],function(Base){return Class("sys.core.db.DbContext",Base,function(attr){var _this=this;attr("override"),this.func("constructor",function(base,db){base(),_this.db=db}),attr("readonly"),this.prop("db"),attr("readonly"),this.prop("tran",{begin:function(){_this.db.beginTran()},commit:function(){_this.db.commitTran()},rollback:function(){_this.db.rollbackTran()}})})}),define("sys.core.db.DiskDB",[(!0)("[Base]"),(!0)("fs-extra | "),(!0)("diskdb | ")],function(Base,fs,diskdb){return Class("sys.core.db.DiskDB",Base,function(attr){var _this=this;attr("override"),attr("sealed"),this.func("constructor",function(base,dbPath){if(base(),!_this.env.isServer)throw"DiskDB implementation is available for server usage only.";if(!dbPath)throw"DiskDB path must be specified.";_this.dbPath=dbPath,fs.existsSync(dbPath)||fs.ensureDirSync(dbPath)});var _db=null;attr("private"),this.prop("db",function(){return null===_db&&(_db=diskdb.connect(_this.dbPath)),_db}),attr("private"),this.func("collection",function(collectionName){return _this.db[collectionName]||_this.db.loadCollections([collectionName]),_this.db[collectionName]}),attr("readonly"),this.prop("dbPath",""),this.func("getCollection",function(collectionName){return Object.freeze({db:_this.dbPath,collection:collectionName,insert:function(data){return _this.insert(collectionName,data)},update:function(query,data,options){return _this.update(collectionName,query,data,options)},remove:function(query,options){return _this.remove(collectionName,query,options)},count:function(){return _this.count(collectionName)},get:function(query){return _this.get(collectionName,query)},getAll:function(query){return _this.getAll(collectionName,query)}})}),this.func("insert",function(collectionName,data){
return _this.collection(collectionName).save(data)}),this.func("update",function(collectionName,query,data,options){return _this.collection(collectionName).update(query,data,options)}),this.func("remove",function(collectionName,query,options){var multi=!0;return options&&"undefined"!=typeof options.multi&&(multi=options.multi),_this.collection(collectionName).remove(query,multi)}),this.func("count",function(collectionName){return _this.collection(collectionName).count()}),this.func("get",function(collectionName,query){return _this.collection(collectionName).findOne(query)}),this.func("getAll",function(collectionName,query){return _this.collection(collectionName).find(query)})})}),define("sys.core.domain.Controller",[(!0)("[Base]")],function(Base){return Class("sys.core.domain.Controller",Base,function(attr){this.func("toDTO",function(entity,Dto){return entity.toDTO(entity,new Dto)}),this.func("toDTOList",function(entities,Dto){var dtos=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=entities[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var entity=_step.value;dtos.push(entity.toDTO(entity,new Dto))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return dtos}),this.func("fromDTO",function(Entity,dto){var entity=new Entity;return entity.fromDTO(entity,dto)}),this.func("fromDTOList",function(Entity,dtos){var entities=[],entity=null,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=dtos[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var dto=_step2.value;entity=new Entity,entities.push(entity.fromDTO(entity,dto))}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return entities})})}),define("sys.core.domain.Entity",[(!0)("[Base]"),(!0)("[Automapper]")],function(Base,Automapper){return Class("sys.core.domain.Entity",Base,function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base){base(),_this.automapper=new Automapper}),attr("protected"),this.prop("automapper"),this.func("toDTO",function(entity,dto){return _this.automapper.from(entity,dto),dto}),this.func("fromDTO",function(entity,dto){return _this.automapper.to(entity,dto),entity})})}),define("sys.core.security.ClaimsChecker",function(){return Class("sys.core.security.ClaimsChecker",function(attr){attr("singleton"),this.func("constructor",function(){}),this.func("check",function(requestedClaims,availableAccess){var success=!1;if(requestedClaims)if(1===requestedClaims.length&&"auth"===requestedClaims[0])success=!0;else{var orClaims=null,hasClaim=function(claim){return availableAccess&&availableAccess.indexOf(claim)!==-1},_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=requestedClaims[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var claim=_step.value;if("auth"!==claim)if(claim.indexOf("||")!==-1){orClaims=claim.split("||");var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=orClaims[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var orClaim=_step2.value;if(success=hasClaim(orClaim))break}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}else if(success=hasClaim(claim),!success)break}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}else success=!0;return success})})}),define("sys.core.security.CredentialsCreator",[(!0)("[Base]"),(!0)("[User]"),(!0)("[Credentials]")],function(Base,User,Credentials){return Class("sys.core.security.CredentialsCreator",Base,function(attr){attr("override"),attr("singleton"),this.func("constructor",function(base){base()}),this.func("create",function(loginId,pwd){var clientId=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return new Credentials(loginId,pwd,clientId)})})}),define("sys.core.security.CredentialsValidator",[(!0)("[Base]"),(!0)("[User]")],function(Base,User){return Class("sys.core.security.CredentialsValidator",Base,function(attr){attr("override"),attr("singleton"),this.func("constructor",function(base){base()}),attr("async"),this.func("validate",function(resolve,reject,credentials){var validatedUser=new User(credentials.loginId,"(Dummy)",[],[],credentials.clientId);resolve(validatedUser)})})}),define("sys.core.security.Crypt",[(!0)("[Base]"),(!0)("sys/core/libs/aes{.min}.js"),(!0)("sys/core/libs/md5{.min}.js")],function(Base){return Class("sys.core.security.Crypt",Base,function(attr){var _this=this;attr("override"),attr("singleton"),this.func("constructor",function(base){base(),_this.secretKey=_this.settings("crypt.secretKey","adfdef1d-ce1a-470d-a652-f466292acf85")}),this.func("encrypt",function(plainText){var secretKey=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return CryptoJS.AES.encrypt(plainText,secretKey||_this.secretKey).toString()}),this.func("decrypt",function(encryptedText){var secretKey=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return CryptoJS.AES.decrypt(encryptedText,secretKey||_this.secretKey).toString(CryptoJS.enc.Utf8)}),this.func("hash",function(text){return CryptoJS.MD5(text).toString()}),attr("private"),this.prop("secretKey","")})}),define("sys.core.ui.Adapter",[(!0)("[Base]")],function(Base){return Class("sys.core.ui.Adapter",Base,function(attr){this.prop("adapterName",""),this.func("observe",this.noop),this.func("unobserve",this.noop),this.func("get",this.noop),this.func("set",this.noop)})}),define("sys.core.ui.Binder",[(!0)("[Base]")],function(Base){return Class("sys.core.ui.Binder",Base,function(attr){this.prop("binderName",""),this.func("bind",this.noop),this.func("unbind",this.noop),this.func("routine",this.noop),this.func("getValue",this.noop),this.prop("isTwoWay",!1),this.prop("publishes",!1),this.prop("block",!1)})}),define("sys.core.ui.Component",[(!0)("[Base]"),(!0)("sys.core.ui.ComponentTypes")],function(Base,ComponentTypes){return Class("sys.core.ui.Component",Base,function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base,type,parent,args){base(),_this.type=type,_this.parent=parent,_this.args=args,_this.data.assets={}}),attr("protected"),attr("sealed"),this.func("init",function(){return new Promise(function(resolve,reject){var defineHost=function(){var $host=null,elClass="";switch(_this.type){case ComponentTypes.Shell:if($host=document.querySelector(_this.settings("view.$stage","#stage")),!$host){var $stage=document.createElement("div");$stage.setAttribute("id","stage"),document.body.append($stage),$host=$stage}elClass=$host.getAttribute("class")||"",elClass.indexOf("ag-stage")===-1&&(elClass="ag-stage "+elClass),$host.setAttribute("class",elClass.trim()),_this._.pr.$host=$host;break;case ComponentTypes.View:if($host=_this.parent._.pr.$el.querySelector(_this.settings("view.$container","#container")),!$host){var $container=document.createElement("div");$container.setAttribute("id","container"),_this.parent._.pr.$el.append($container),$host=$container}elClass=$host.getAttribute("class")||"",elClass.indexOf("ag-container")===-1&&(elClass="ag-container "+elClass),$host.setAttribute("class",elClass.trim()),_this._.pr.$host=$host;break;case ComponentTypes.Partial:}},loadHtml=function(){return new Promise(function(resolve,reject){var onLoadHtml=function(html){switch(html=replaceAll(html,"{.min}",_this.env.isProd?".min":""),html=replaceAll(html,"~/",_this.url()),_this.type){case ComponentTypes.Shell:html=replaceAll(html,"@:","shell.");break;case ComponentTypes.View:html=replaceAll(html,"@:","view.");break;case ComponentTypes.Partial:html=replaceAll(html,"@:","partials."+_this._.id+".")}var template=document.createElement("template");template.innerHTML=html,_this._.pr.$el=template.content.firstElementChild,_this._.pr.$el.setAttribute("id",_this._.id);var elClass=_this._.pr.$el.getAttribute("class")||"",elClassName="";switch(_this.type){case ComponentTypes.Shell:elClassName="shell";break;case ComponentTypes.View:elClassName="view";break;case ComponentTypes.Partial:elClassName="partial"}elClass.indexOf("ag-"+elClassName)===-1&&(elClass="ag-"+elClassName+" "+elClass),_this._.pr.$el.setAttribute("class",elClass.trim()),resolve()};if(_this.template)onLoadHtml(_this.template);else{var template=_this.url("index.html");include([template]).then(onLoadHtml).catch(reject)}})},initPartials=function(){return new Promise(function(_resolve,_reject){var $partials=_this._.pr.$el.querySelectorAll("[ag-partial]"),partials=[],partialClassParams=[],partialObjects=[],className="",args=null,tagName="",_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=$partials[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var $partial=_step.value;className=(!0)($partial.getAttribute("ag-partial")),args=$partial.getAttribute("ag-args"),tagName=$partial.getAttribute("ag-name"),args=args?_this.env.queryStringToObject(args):null,partials.push(className),partialClassParams.push({$host:$partial,args:args,tagName:tagName})}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}include(partials,!0).then(function(PartialClasses){if(PartialClasses){var i=0,pa=null,po=null,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=PartialClasses[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var PartialClass=_step2.value;pa=partialClassParams[i],po=new PartialClass(_this,pa.args),po._.pr.$host=pa.$host,po._.pr.tagName=pa.tagName||po._.id,partialObjects.push(po),i++}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}forAsync(partialObjects,function(__resolve,__reject,partialObject){partialObject._.pr.init().then(function(){if(_this.partials[partialObject._.pr.tagName])throw"partial names must be unique. "+partialObject._.pr.tagName;_this.partials[partialObject._.pr.tagName]=partialObject,__resolve()}).catch(__reject)}).then(_resolve).catch(_reject)}else _resolve()}).catch(_reject)})},loadDeps=function(){return new Promise(function(resolve,reject){var deps=_this._.pr.$el.getAttribute("ag-deps");if(deps){var items=deps.split(","),styles=[],others=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=items[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var item=_step3.value;item=_this.url(item),item.startsWith("text!")?styles.push(item):others.push(item)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}include(others).then(function(){include(styles,!0).then(function(allStyles){if(allStyles){var _iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_iterator4=allStyles[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0){var thisStyle=_step4.value;thisStyle&&(_this.styles+="\n/* next */\n"+thisStyle)}}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}}resolve()}).catch(reject)}).catch(reject)}else resolve()})},loadAssets=function(){return new Promise(function(resolve,reject){var assetNames=[],assets=[];for(var assetName in _assets)_this.asset.hasOwnProperty(assetName)&&(assetNames.push(assetName),assets.push(_this.asset[assetName]));include(assets,!0).then(function(){var objects=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=0,assetName="",assetValue="",_iteratorNormalCompletion5=!0,_didIteratorError5=!1,_iteratorError5=void 0;try{for(var _step5,_iterator5=objects[Symbol.iterator]();!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=!0){var assetObject=_step5.value;assetName=assetNames[i],_this.data.assets[assetName]=assetObject;for(var assetKey in assetObject)assetObject.hasOwnProperty(assetKey)&&(assetValue=assetObject[assetKey],"/"===assetValue.substr(0,1)&&(assetObject[assetKey]=_this.url(assetValue)));i++}}catch(err){_didIteratorError5=!0,_iteratorError5=err}finally{try{!_iteratorNormalCompletion5&&_iterator5.return&&_iterator5.return()}finally{if(_didIteratorError5)throw _iteratorError5}}resolve()}).catch(reject)})};_this._.pr.beforeInit().then(function(){loadAssets().then(function(){loadHtml().then(function(){defineHost(),loadDeps().then(function(){initPartials().then(function(){_this._.pr.afterInit().then(resolve).catch(reject)}).catch(reject)}).catch(reject)}).catch(reject)}).catch(reject)}).catch(reject)})}),attr("protected"),this.prop("$el",null),attr("protected"),this.prop("$host",null),attr("protected"),this.prop("$style",null),attr("protected"),this.prop("styles",""),attr("protected"),this.prop("template",""),attr("protected"),attr("async"),this.func("beforeInit",this.noopAsync),attr("protected"),attr("async"),this.func("afterInit",this.noopAsync),attr("protected"),attr("async"),this.func("beforeShow",this.noopAsync),attr("protected"),attr("async"),this.func("afterShow",this.noopAsync),attr("protected"),attr("async"),this.func("beforeHide",this.noopAsync),attr("protected"),attr("async"),this.func("afterHide",this.noopAsync),attr("readonly"),this.prop("partials",{}),attr("readonly"),this.prop("type",-1),attr("readonly"),this.prop("parent",null),attr("readonly"),attr("once"),this.prop("args",null);var _root="";attr("protected"),attr("sealed"),this.func("url",function(){var relativeUrl=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";_root||(_root=(!0)(_this._.name,"server"),_root=_root.replace("modules/","").replace(".js","")+"/"),"/"===relativeUrl.substr(0,1)&&(relativeUrl=relativeUrl.substr(1)),relativeUrl.indexOf("/assets/")!==-1&&(relativeUrl=relativeUrl.replace("/assets/","/assets/"+_this.env.getLocate().name+"/"));var _path=_root+relativeUrl;return _path.endsWith(".css")?_path="text!"+_path:_path.endsWith(".html")&&(_path="text!"+_path),_path}),attr("protected"),attr("sealed"),this.func("pub",function(topic){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];var handlers=_this.env.get("handlers",null);handlers||_this.env.get("handlers",{});var topicHandlers=handlers[topic]||[],_iteratorNormalCompletion6=!0,_didIteratorError6=!1,_iteratorError6=void 0;try{for(var _step6,_iterator6=topicHandlers[Symbol.iterator]();!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=!0){var handler=_step6.value;handler.apply(void 0,args)}}catch(err){_didIteratorError6=!0,_iteratorError6=err}finally{try{!_iteratorNormalCompletion6&&_iterator6.return&&_iterator6.return()}finally{if(_didIteratorError6)throw _iteratorError6}}}),attr("protected"),attr("sealed"),this.func("sub",function(topic,handler){var handlers=_this.env.get("handlers",null);handlers||_this.env.set("handlers",{}),handlers[topic]=handlers[topic]||[],handlers[topic].push(handler)}),attr("protected"),attr("sealed"),this.func("data",function(name,value){if("function"==typeof value)throw"data value cannot be a function.";if(_this._.bindable=_this._.bindable||{},"undefined"!=typeof _this._.bindable[name])throw name+" already defined as data/handler.";_this._.bindable[name]=value,Object.defineProperty(_this.data,name,{get:function(){return _this._.bindable[name]},set:function(value){_this._.bindable[name]=value}})}),attr("sealed"),this.func("setData",function(data){if(data)for(var name in data)data.hasOwnProperty(name)&&("undefined"==typeof _this.data[name]?_this.data(name,data[name]):_this.data[name]=data[name])}),attr("sealed"),this.func("getData",function(){var data={};for(var name in _this._.bindable)_this._.bindable.hasOwnProperty(name)&&"undefined"!=typeof _this.data.name&&(data[name]=_this.data[name]);return data}),attr("protected"),attr("sealed"),this.func("handler",function(name,fn){if("function"!=typeof fn)throw"handler value must be a function.";var wrappedFn=function(e){fn(e.currentTarget,e)};if(_this._.bindable=_this._.bindable||{},"undefined"!=typeof _this._.bindable[name])throw name+" already defined as data/handler.";_this._.bindable[name]=wrappedFn,Object.defineProperty(_this.handler,name,{value:wrappedFn})});var _assets={};attr("protected"),this.func("asset",function(name,bundleUrl){if("undefined"!=typeof _this.asset[name])throw name+" already defined.";_this.asset[name]=_this.url(bundleUrl),_assets[name]=_this.asset[name]}),this._.cfas=function(asyncFuncName){for(var _len2=arguments.length,args=Array(_len2>2?_len2-2:0),_key2=2;_key2<_len2;_key2++)args[_key2-2]=arguments[_key2];var isSkipPartials=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise(function(resolve,reject){var _parent$_,callOnPartials=function(_obj){return new Promise(function(_resolve,_reject){var allPartials=[];for(var po in _obj.partials)_obj.partials.hasOwnProperty(po)&&allPartials.push(_obj.partials[po]);allPartials.length>0?forAsync(allPartials,function(__resolve,__reject,partial){var _partial$_;(_partial$_=partial._).cfas.apply(_partial$_,[asyncFuncName].concat(args)).then(__resolve).catch(__reject)}).then(_resolve).catch(_reject):_resolve()})};switch(_this.type){case ComponentTypes.Shell:if("function"==typeof _this._.pr[asyncFuncName]){var _$pr;(_$pr=_this._.pr)[asyncFuncName].apply(_$pr,args).then(function(){isSkipPartials?resolve():callOnPartials(_this).then(resolve).catch(reject)}).catch(reject)}else resolve();break;case ComponentTypes.View:(_parent$_=_this.parent._).cfas.apply(_parent$_,[asyncFuncName,isSkipPartials].concat(args)).then(function(){if("function"==typeof _this._.pr[asyncFuncName]){var _$pr2;(_$pr2=_this._.pr)[asyncFuncName].apply(_$pr2,args).then(function(){isSkipPartials?resolve():callOnPartials(_this).then(resolve).catch(reject)}).catch(reject)}else resolve()}).catch(reject);break;case ComponentTypes.Partial:if("function"==typeof _this._.pr[asyncFuncName]){var _$pr3;(_$pr3=_this._.pr)[asyncFuncName].apply(_$pr3,args).then(function(){callOnPartials(_this).then(resolve).catch(reject)}).catch(reject)}else resolve()}})}})}),define("sys.core.ui.ComponentTypes",function(){return Enum("sys.core.ui.ComponentTypes",{Shell:0,View:1,Partial:2})}),define("sys.core.ui.Formatter",[(!0)("[Base]")],function(Base){return Class("sys.core.ui.Formatter",Base,function(attr){this.prop("formatterName",""),this.func("read",this.noop),this.func("publish",this.noop),this.prop("isTwoWay",!1)})}),define("sys.core.ui.Partial",[(!0)("sys.core.ui.Component"),(!0)("sys.core.ui.ComponentTypes")],function(Component,ComponentTypes){return Class("sys.core.ui.Partial",Component,function(attr){attr("override"),attr("abstract"),this.func("constructor",function(base,parent,args){base(ComponentTypes.Partial,parent,args)}),attr("protected"),attr("once"),this.prop("tagName","")})}),define("sys.core.ui.Shell",[(!0)("sys.core.ui.Component"),(!0)("sys.core.ui.ComponentTypes")],function(Component,ComponentTypes){return Class("sys.core.ui.Shell",Component,function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base,args,view){base(ComponentTypes.Shell,null,args),_this.child=view}),attr("readonly"),this.prop("child",null)})}),define("sys.core.ui.Transition",[(!0)("[Base]")],function(Base){return Class("sys.core.ui.Transition",Base,function(attr){this.func("in",function($new){var $current=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;$current&&($current.style.display="none"),$new.style.display="block"}),this.func("out",function($current){var $new=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;$current.style.display="none",$new&&($new.style.display="block")})})}),define("sys.core.ui.View",[(!0)("[Base]"),(!0)("sys.core.ui.Component"),(!0)("sys.core.ui.ComponentTypes"),(!0)("sys.core.ui.Transition"),(!0)("sys.core.bootwares.client.DataBinder")],function(Base,Component,ComponentTypes,DefaultTransition,DataBinder){return Class("sys.core.ui.View",Component,function(attr){var _this=this;attr("override"),attr("abstract"),this.func("constructor",function(base,Shell,Transition){var shell=new Shell(null,_this);base(ComponentTypes.View,shell,null),Transition?_this.transition=new Transition:_this.transition=new DefaultTransition}),attr("protected"),this.prop("request",null),attr("async"),this.func("navigate",function(resolve,reject,request){_this.request=request,_this.args=request.args,_this.stage().then(function(){_this.current=_this._.pu,resolve(_this.current)}).catch(function(err){console.log("Failed to navigate to "+request.url+". ("+(err||"")+");"),reject(err)})}),attr("private"),attr("async"),this.func("stage",function(resolve,reject){if(_this.current!==_this){_this.env.set("handlers",{});var last=_this.current,current=_this;_this.parent._.pr.init().then(function(){_this._.pr.init().then(function(){last?last._.cfas("beforeHide").then(function(){current._.cfas("beforeShow").then(function(){current._.pr.mount(),current._.pr.bind(),_this.setDirection(),_this.transition.in(current._.pr.$el,last._.pr.$el),last._.cfas("afterHide").then(function(){last._.pr.unbind(),last._.pr.unmount(),current._.cfas("afterShow").then(function(){current._.pr.focus(),resolve()}).catch(reject)}).catch(reject)}).catch(reject)}).catch(reject):current._.cfas("beforeShow").then(function(){current._.pr.mount(),current._.pr.bind(),_this.setDirection(),_this.transition.in(current._.pr.$el),current._.cfas("afterShow").then(function(){current._.pr.focus(),resolve()}).catch(reject)}).catch(reject)}).catch(reject)}).catch(reject)}else resolve()}),attr("private"),this.prop("transition",null),attr("private"),this.prop("current",function(){return _this.env.get("currentView",null)},function(view){_this.env.set("currentView",view)}),attr("private"),this.func("setDirection",function(){var currentRTL=document.body.getAttribute("dir");_this.env.getLocale().rtl?"rtl"!==currentRTL&&document.body.setAttribute("dir","rtl"):"rtl"===currentRTL&&document.body.setAttribute("dir","")}),attr("protected"),attr("sealed"),this.func("mount",function(){var mountStyles=function(obj){obj._.pr.styles&&(obj._.pr.$style=document.createElement("style"),obj._.pr.$style.setAttribute("scoped",""),obj._.pr.$style.appendChild(document.createTextNode(obj._.pr.styles)),obj._.pr.$el.prepend(obj._.pr.$style))},mountPartial=function(partial){partial._.pr.$host.append(partial._.pr.$el),mountStyles(partial),mountPartials(partial.partials)},mountPartials=function(partials){var partial=null;for(var po in partials)partials.hasOwnProperty(po)&&(partial=partials[po],mountPartial(partial))};_this.parent._.pr.$host.append(_this.parent._.pr.$el),mountStyles(_this.parent),mountPartials(_this.parent.partials),_this._.pr.$host.append(_this._.pr.$el),mountStyles(_this),mountPartials(_this.partials)}),attr("protected"),attr("sealed"),this.func("unmount",function(){var unmountStyles=function(obj){obj._.pr.$style&&obj._.pr.$style.remove()},unmountPartial=function(partial){unmountStyles(partial),partial._.pr.$el.remove(),unmountPartials(partial.partials)},unmountPartials=function(partials){var partial=null;for(var po in partials)partials.hasOwnProperty(po)&&(partial=partials[po],unmountPartial(partial))};unmountStyles(_this),_this._.pr.$el.remove(),unmountPartials(_this.partials),unmountStyles(_this.parent),_this.parent._.pr.$el.remove(),unmountPartials(_this.parent.partials)});var _bindedView=null;attr("protected"),attr("sealed"),this.func("bind",function(){if(!_bindedView){var getPartialBindings=function getPartialBindings(target,_obj){var partial=null;for(var po in _obj.partials)_obj.partials.hasOwnProperty(po)&&(partial=_obj.partials[po],target[partial._.id]=partial._.bindable,getPartialBindings(target,partial))},obj={partials:{},shell:_this.parent._.bindable,view:_this._.bindable};getPartialBindings(obj.partials,_this.parent),getPartialBindings(obj.partials,_this);var binder=new DataBinder;_bindedView=binder.bind(_this.parent._.pr.$el,obj)}}),attr("protected"),attr("sealed"),this.func("unbind",function(){if(_bindedView){var binder=new DataBinder;binder.unbind(_bindedView),_bindedView=null}}),attr("protected"),attr("sealed"),this.func("focus",function(){var $focus=_this._.pr.$el.querySelector("[ag-focus");$focus&&$focus.focus()}),attr("protected"),this.func("redirect",function(){_this.request.query&&_this.request.query.returnUrl&&App.navigate(_this.request.query.returnUrl,!0)}),this.data("title","")})}),define("sys.core.bootwares.client.DataBinder",[(!0)("[Base]"),(!0)("[IBootware]")],function(Base,IBootware){return Class("sys.core.bootwares.client.DataBinder",Base,[IBootware],function(attr){var _this=this;attr("singleton"),attr("override"),this.func("constructor",function(base){base()}),attr("async"),this.func("boot",function(resolve,reject,app){var shimFor={name:"rivets",path:"sys/core/libs/rivets{.min}.js"},shimDeps=[{name:"sightglass",path:"sys/core/libs/sightglass{.min}.js"}];_this.env.addShim(shimFor,shimDeps),include([(!0)("rivets")]).then(function(rivets){_this.rivets=rivets;var rivetsConfig=_this.settings("rivets.config",null);rivetsConfig&&rivets.configure(rivetsConfig);var loadBinders=function(){return new Promise(function(_resolve,_reject){var items=_this.settings("rivets.binders",null);items?forAsync(items,function(__resolve,__reject,item){include([(!0)(item)]).then(function(Binder){var obj=new Binder;if(!obj.binderName)throw"Binder name is not defined. ("+obj._.name+")";rivets.binders[obj.binderName]||(obj.isTwoWay?rivets.binders[obj.binderName]={bind:obj.bind,unbind:obj.unbind,routine:obj.routine,getValue:obj.getValue,publishes:obj.publishes,block:obj.block}:rivets.binders[obj.binderName]=obj.routine),__resolve()}).catch(__reject)}).then(_resolve).catch(_reject):_resolve()})},loadFormatters=function(){return new Promise(function(_resolve,_reject){var items=_this.settings("rivets.formatters",null);items?forAsync(items,function(__resolve,__reject,item){include([(!0)(item)]).then(function(Formatter){var obj=new Formatter;if(!obj.formatterName)throw"Formatter name is not defined. ("+obj._.name+")";rivets.formatters[obj.formatterName]||(obj.isTwoWay?rivets.formatters[obj.formatterName]={read:obj.read,publish:obj.publish}:rivets.formatters[obj.formatterName]=obj.read),__resolve()}).catch(__reject)}).then(_resolve).catch(_reject):_resolve()})},loadAdapters=function(){return new Promise(function(_resolve,_reject){var items=_this.settings("rivets.adapters",null);items?forAsync(items,function(__resolve,__reject,item){include([(!0)(item)]).then(function(Adapter){var obj=new Adapter;if(!obj.adapterName)throw"Adapter name is not defined. ("+obj._.name+")";rivets.adapters[obj.adapterName]||(rivets.adapters[obj.adapterName]={observe:obj.observe,unobserve:obj.unobserve,get:obj.get,set:obj.set}),__resolve()}).catch(__reject)}).then(_resolve).catch(_reject):_resolve()})};loadBinders().then(function(){loadFormatters().then(function(){loadAdapters().then(resolve).catch(reject)}).catch(reject)}).catch(reject)}).catch(reject)}),attr("async"),this.func("ready",this.noopAsync),attr("private"),this.prop("rivets",null),this.func("bind",function($el,obj){return rivets.bind($el,obj)}),this.func("unbind",function(bindedView){bindedView.unbind()})})}),define("sys.core.bootwares.client.Dependencies",[(!0)("[Base]"),(!0)("[IBootware]")],function(Base,IBootware){return Class("sys.core.bootwares.client.Dependencies",Base,[IBootware],function(attr){var _this=this;attr("async"),this.func("boot",function(resolve,reject,app){var dependencies=_this.settings("dependencies",[]),deps=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=dependencies[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var dep=_step.value;deps.push((!0)(dep))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}forAsync(deps,function(resolve,reject,dep){_this.env.loadScript(dep).then(resolve).catch(reject)}).then(resolve).catch(reject)}),attr("async"),this.func("ready",this.noopAsync)})}),define("sys.core.bootwares.server.Middlewares",[(!0)("[Base]"),(!0)("[IBootware]")],function(Base,IBootware){return Class("sys.core.bootwares.server.Middlewares",Base,[IBootware],function(attr){var _this=this;attr("async"),this.func("boot",function(resolve,reject,app){var middlewares=_this.settings("middlewares",[]),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=middlewares[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;if(mw=require((!0)(item.name)),mw)if(item.args)if(item.func){var _mw;app.use((_mw=mw)[item.func].apply(_mw,_toConsumableArray(item.args))),_this.env.isDev&&console.log("middleware: "+item.name+"."+item.func+"("+item.args+")")}else app.use(mw.apply(void 0,_toConsumableArray(item.args))),_this.env.isDev&&console.log("middleware: "+item.name+"("+item.args+")");else item.func?(app.use(mw[item.func]()),_this.env.isDev&&console.log("middleware: "+item.name+"."+item.func+"()")):(app.use(mw()),_this.env.isDev&&console.log("middleware: "+item.name+"()"))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}resolve()}),attr("async"),this.func("ready",this.noopAsync)})}),define("sys.core.bootwares.server.StaticServer",[(!0)("[Base]"),(!0)("[IBootware]"),(!0)("serve-favicon"),(!0)("express")],function(Base,IBootware,favicon,express){return Class("sys.core.bootwares.server.StaticServer",Base,[IBootware],function(attr){var _this=this;attr("async"),this.func("boot",function(resolve,reject,app){var fi=_this.settings("static.favIcon","");fi&&(app.use(favicon((!0)(fi))),_this.env.isDev&&console.log("favIcon: "+fi));var age=_this.settings("static.caching.age",0),mainModule=_this.settings(":main","sample"),staticFolders=_this.settings(":static",[]);if(staticFolders.unshift("web."+mainModule),staticFolders.unshift(_this.assembly),_this.settings("static.caching.enabled")&&0!==age){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=staticFolders[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var staticFolder=_step.value;staticFolder=(!0)(staticFolder).replace("members/","").replace(".js","")+"static/",app.use("/",express.static(staticFolder,{maxAge:age})),_this.env.isDev&&console.log("static: / = "+staticFolder)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError;
}}app.use("/web",express.static((!0)("./web/modules/"),{maxAge:age})),_this.env.isDev&&console.log("static: /web = "+(!0)("./web/modules/")),app.use("/sys",express.static((!0)("./sys/modules/"),{maxAge:age})),_this.env.isDev&&console.log("static: /sys = "+(!0)("./sys/modules/"))}else{var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=staticFolders[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var _staticFolder=_step2.value;_staticFolder=(!0)(_staticFolder).replace("members/","").replace(".js","")+"static/",app.use("/",express.static(_staticFolder)),_this.env.isDev&&console.log("static: / = "+_staticFolder)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}app.use("/web",express.static((!0)("./web/modules/"))),_this.env.isDev&&console.log("static: /web = "+(!0)("./web/modules/")),app.use("/sys",express.static((!0)("./sys/modules/"))),_this.env.isDev&&console.log("static: /sys = "+(!0)("./sys/modules/"))}resolve()}),attr("async"),this.func("ready",this.noopAsync)})}),define("sys.core.security.client.Auth",[(!0)("[Base]"),(!0)("[User]"),(!0)("[ClaimsChecker]")],function(Base,User,ClaimsChecker){return Class("sys.core.security.client.Auth",Base,function(attr){var _this=this;attr("override"),attr("singleton"),this.func("constructor",function(base){base()}),attr("async"),this.func("validate",function(resolve,reject,request){var token=_this.token,user=_this.user;if(token)if(user){var claimsChecker=new ClaimsChecker;claimsChecker.check(request.claims,user.access)?(request.user=user,resolve()):reject("Unauthorized.")}else reject("Unauthorized user.");else reject("Authentication token is not available.")}),attr("service","/auth",{method:"POST",requestDataType:"application/json",responseDataType:"json",pre:function(args){args.body={credentials:args.body}}}),this.func("login",function(service,resolve,reject,credentials){service({credentials:credentials}).then(function(response){if(response.isError)reject(response.error);else{var loginResult=response.data;_this.token=loginResult.token,_this.user=loginResult.user,resolve(_this.user)}}).catch(reject)}),this.func("logout",function(){_this.token=null,_this.user=null}),this.prop("isLoggedIn",function(){return!(!_this.token||!_this.user)}),this.func("getToken",function(){return _this.token}),this.func("getTokenHeader",function(){return{Authorization:"Bearer "+_this.token}}),this.func("getUser",function(){return _this.user}),attr("private"),attr("session"),this.prop("token",null),attr("private"),attr("session"),this.prop("user",null)})}),define("sys.core.security.dto.AuthInfo",function(){return Structure("sys.core.security.dto.AuthInfo",function(token,user){this.token=token,this.user=user})}),define("sys.core.security.dto.Credentials",function(){return Structure("sys.core.security.dto.Credentials",function(loginId,pwdHash){var clientId=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this.clientId=clientId,this.loginId=loginId,this.pwdHash=pwdHash})}),define("sys.core.security.dto.User",function(){return Structure("sys.core.security.dto.User",function(loginId,name,roles,access){var clientId=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";this.clientId=clientId,this.loginId=loginId,this.name=name,this.roles=roles,this.access=access})}),define("sys.core.security.server.Auth",[(!0)("[Base]"),(!0)("[User]"),(!0)("[ClaimsChecker]"),(!0)("[Credentials]"),(!0)("[CredentialsValidator]"),(!0)("sys.core.security.server.JwtToken"),(!0)("sys.core.security.dto.AuthInfo")],function(Base,User,ClaimsChecker,Credentials,CredentialsValidator,Jwt,AuthInfo){return Class("sys.core.security.server.Auth",Base,function(attr){attr("override"),attr("singleton"),this.func("constructor",function(base){base()}),attr("async"),this.func("validate",function(resolve,reject,request){var token=request.getToken();if(token){var _jwt=new Jwt;_jwt.verify(token).then(function(user){if(user){var claimsChecker=new ClaimsChecker;claimsChecker.check(request.claims,user.access)?(request.user=user,resolve()):reject("Unauthorized")}else reject("Unauthorized user.")}).catch(reject)}else reject("Authentication token is not available.")}),attr("async"),this.func("login",function(resolve,reject,request){var credentials=request.data.credentials||{},credentialsValidator=new CredentialsValidator;credentialsValidator.validate(credentials).then(function(user){user?(jwt=new Jwt,jwt.create(user).then(function(token){if(token){var authInfo=new AuthInfo(token,user);request.response.send.json(authInfo),resolve(authInfo)}else request.response.send.error(401,"Failed to generate auth token."),reject(401)}).catch(function(err){request.response.send.error(401,"Failed to generate auth token. ("+(err||"")+")"),reject(err)})):(request.response.send.error(401,"User not found."),reject(401))}).catch(function(err){request.response.send.error(401,"Invalid user name or password. ("+(err||"")+")"),reject(err)})})})}),define("sys.core.security.server.JwtToken",[(!0)("[Base]"),(!0)("jsonwebtoken")],function(Base,jwt){return Class("sys.core.security.server.JwtToken",Base,function(attr){var _this=this;attr("async"),this.func("create",function(resolve,reject,payload){var secret=_this.settings("security.jwt.secretKey","adfdef1d-ce1a-470d-a652-f466292acf85"),expiresInMinutes=_this.settings("security.jwt.expiresInMinutes",30),token=jwt.sign(payload,secret,{expiresIn:60*expiresInMinutes});resolve(token)}),attr("async"),this.func("verify",function(token){var secret=_this.settings("security.jwt.secretKey","adfdef1d-ce1a-470d-a652-f466292acf85");jwt.verify(token,secret,function(err,payload){err?reject(err):resolve(payload)})})})}),define("sys.core.ui.binders.xClass",[(!0)("sys.core.ui.Binder")],function(Binder){return Class("sys.core.ui.binders.Xclass",Binder,function(attr){var _this=this;attr("override"),this.func("constructor",function(base){base(),_this.binderName="xclass",_this.isTwoWay=!1}),attr("override"),this.func("routine",function(base,$el,value){base(),$el.className+=" "+value})})}),define("sys.core.ui.formatters.Percent",[(!0)("sys.core.ui.Formatter")],function(Formatter){return Class("sys.core.ui.formatters.Percent",Formatter,function(attr){var _this=this;attr("override"),this.func("constructor",function(base){base(),_this.formatterName="percent",_this.isTwoWay=!1}),attr("override"),this.func("read",function(base,value){return base(),value+"%"})})});