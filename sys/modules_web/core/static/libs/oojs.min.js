/**
 * oojs.js
 * version 1.0.0
 * (C) 2017, Vikas Burman
 * MIT License 
 */
(function(){const def=(opts={})=>{let isServer=new Function("try {return this===global;}catch(e){return false;}")(),getGlobal=new Function("try {return (this===global ? global : window);}catch(e){return window;}"),oojs={},noop=()=>{},noopAsync=(resolve,reject)=>{resolve()},options={env:opts.env||(isServer?"server":"client"),global:getGlobal(),supressGlobals:"undefined"!=typeof opts.supressGlobals&&opts.supressGlobals,symbols:opts.symbols||[]};oojs.Class=((arg1,arg2,arg3,arg4)=>{let className=arg1,inherits=null,mixins=[],interfaces=[],factory=null;"function"==typeof arg3?(factory=arg3,Array.isArray(arg2)?mixins=arg2:inherits=arg2):"function"==typeof arg4?(inherits=arg2,mixins=arg3,factory=arg4):"function"==typeof arg2&&(factory=arg2);let onlyMixins=[];for(let mixin of mixins)switch(mixin._.type){case"mixin":onlyMixins.push(mixin);break;case"interface":interfaces.push(mixin)}mixins=onlyMixins;let Class=function(_flag,_static,...args){let Parent=Class._.inherits,_this={},_exposed_this={},singleInstance=null,bucket=[],meta={},props={},events=[],classArgs=[],isNeedProtected=!1,staticInterface=null,theFlag="__flag__",mixin_being_applied=null;if(singleInstance=Class._.singleInstance())return singleInstance;if(_flag&&_flag===theFlag?(staticInterface=_static,isNeedProtected=!0,classArgs=args):(staticInterface=Class._.static,"undefined"!=typeof _flag?(classArgs=classArgs.concat([_flag]),"undefined"!=typeof _static&&(classArgs=classArgs.concat([_static]),"undefined"!=typeof args&&(classArgs=classArgs.concat(args)))):classArgs=args),Parent&&(_this=new Parent(theFlag,staticInterface,...classArgs),Parent._.isSealed()||Parent._.isSingleton()))throw`${className} cannot inherit from a sealed/singleton class ${Parent._.name}.`;const guid=()=>{return"_xxxxxxxx_xxxx_4xxx_yxxx_xxxxxxxxxxxx".replace(/[xy]/g,c=>{var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})},isSingletonClass=()=>{return hasAttr("singleton",meta._constructor)},isAbstractClass=()=>{return hasAttr("abstract",meta._constructor)},isSpecialMember=member=>{return["constructor","dispose","_constructor","_dispose","_"].indexOf(member)!==-1},isOwnMember=member=>{return"undefined"!=typeof meta[member]},isDerivedMember=member=>{return!isOwnMember(member)&&_this._.instanceOf.findIndex(item=>{return!!item.meta[member]})!==-1},memberType=member=>{let result="";if("undefined"!=typeof meta[member])result=meta[member].type;else for(let instance of _this._.instanceOf)if(instance.meta[member]){result=instance.meta[member].type;break}return result},isSealedMember=member=>{return hasAttr("sealed",meta[member])},isStaticMember=member=>{return hasAttr("static",meta[member])},isPrivateMember=member=>{return hasAttr("private",meta[member])},isHiddenMember=member=>{return hasAttr("hide",meta[member])},isProtectedMember=member=>{return hasAttrEx("protected",member)},isSerializableMember=member=>{return hasAttrEx("serialize",member)},isConditionalMemberOK=member=>{let isOK=!0,_meta=meta[member],condition="";if(_meta)for(let item of _meta)if("conditional"===item.name){switch(isOK=!1,condition=item.args&&item.args.length>0?item.args[0]:""){case"server":isOK="server"===options.env;break;case"client":isOK="client"===options.env||""===options.env;break;default:isOK=options.symbols.indexOf(condition)!==-1}break}return isOK},doCopy=member=>{Object.defineProperty(_exposed_this,member,Object.getOwnPropertyDescriptor(_this,member))},isArrowFunction=fn=>{return!fn.hasOwnProperty("prototype")},attr=(attrName,...args)=>{let Attr=null;"string"==typeof attrName?Attr=oojs.Container.get(attrName)[0]:(Attr=attrName,attrName=Attr._.name),bucket.push({name:attrName,Attr:Attr,args:args})},getAttrArgs=(attrName,member)=>{let attrArgs=null;for(let item of _this._.instanceOf)if(item.meta[member]){for(let attrItem of item.meta[member])if(attrItem.name===attrName){attrArgs=attrItem.args;break}if(attrArgs)break}return null!==attrArgs?attrArgs:[]},applyAttr=targetName=>{let Attr=null,targetType=meta[targetName].type,attrArgs=null,attrInstance=null,decorator=null;for(let info of meta[targetName])if(Attr=info.Attr,Attr&&(attrArgs=info.args||[],attrInstance=new Attr(...attrArgs),decorator=attrInstance.decorator(),"function"==typeof decorator)){let descriptor=Object.getOwnPropertyDescriptor(_this,targetName);decorator(_this,targetType,targetName,descriptor),Object.defineProperty(_this,targetName,descriptor)}},hasAttr=(attrName,_meta)=>{let has=!1;return _meta&&(has=_meta.findIndex(item=>{return item.name===attrName})!==-1),has},hasAttrEx=(attrName,member)=>{return _this._.instanceOf.findIndex(item=>{return!!item.meta[member]&&hasAttr(attrName,item.meta[member])})!==-1},isDefined=(member,ignoreLast)=>{let result=!1,last=_this._.instanceOf.length,i=1;for(let instance of _this._.instanceOf){if(instance.meta[member]&&i!==last){result=!0;break}i++}return result},isPatternMatched=(pattern,name)=>{let isMatched="*"===pattern;return isMatched||(pattern.indexOf("*")!==-1?(pattern=pattern.replace("*","[\\w]"),pRegEx=new RegExp(pattern),isMatched=pRegEx.test(name)):isMatched=pattern===name),isMatched},applyAspects=(funcName,funcAspects)=>{let fn=_this[funcName],before=[],after=[],around=[],instance=null,_fn=null;for(let funcAspect of funcAspects)instance=new funcAspect,_fn=instance.before(),"function"==typeof _fn&&before.push(_fn),_fn=instance.around(),"function"==typeof _fn&&around.push(_fn),_fn=instance.after(),"function"==typeof _fn&&after.push(_fn);around.length>0&&around.reverse();let weavedFn=function(...args){let error=null,result=null,ctx={obj:()=>{return _this},className:()=>{return className},funcName:()=>{return funcName},error:err=>{return err&&(error=err),error},result:value=>{return"undefined"!=typeof value&&(result=value),result},args:()=>{return args},data:{}};for(let beforeFn of before)try{beforeFn(ctx)}catch(err){error=err}const runAfterFn=_ctx=>{for(let afterFn of after)try{afterFn(_ctx)}catch(err){ctx.error(err)}};let newFn=fn,isASync=!1,_result=null;for(let aroundFn of around)newFn=aroundFn(ctx,newFn);try{_result=newFn(...args),_result&&"function"==typeof _result.then?(isASync=!0,ctx.result(new Promise((__resolve,__reject)=>{_result.then(value=>{ctx.result(value),runAfterFn(ctx),__resolve(ctx.result())}).catch(err=>{ctx.error(err),runAfterFn(ctx),__reject(ctx.error())})}))):(ctx.result(_result),runAfterFn(ctx))}catch(err){ctx.error(err)}return ctx.result()}.bind(_this);return weavedFn},getClassAspects=()=>{let classAspects={};for(let entry in allAspects)allAspects.hasOwnProperty(entry)&&isPatternMatched(entry.split(".")[0],className)&&(classAspects[entry]=allAspects[entry]);return classAspects},getFuncAspects=(classAspects,funcName)=>{let funcAspects=[];for(let entry in classAspects)classAspects.hasOwnProperty(entry)&&isPatternMatched(entry.split(".")[1],funcName)&&funcAspects.push(...classAspects[entry]);return funcAspects},weave=()=>{if(["Attribute","Aspect"].indexOf(className)===-1&&!_this._.isInstanceOf("Attribute")&&!_this._.isInstanceOf("Aspect")){let classAspects=getClassAspects(),funcAspects=[];for(let entry in meta)meta.hasOwnProperty(entry)&&"func"===meta[entry].type&&!isSpecialMember(entry)&&(funcAspects=getFuncAspects(classAspects,entry),funcAspects.length>0&&(meta[entry].aspects=funcAspects.slice(),Object.defineProperty(_this,entry,{value:applyAspects(entry,funcAspects)})))}},processJson=(source,target,isDeserialize)=>{let mappedName="";for(member in _this)_this.hasOwnProperty(member)&&("prop"!==memberType(member)||!isSerializableMember(member)||hasAttrEx("readonly",member)||isStaticMember(member)||isPrivateMember(member)||isProtectedMember(member)||isSpecialMember(member)||(mappedName=getAttrArgs("serialize",member)[0]||member,isDeserialize?target[member]=source[mappedName]||target[member]:target[mappedName]=source[member]))};if(_this.func=((name,fn)=>{if("_"===name)throw`${className}.${name} is not allowed.`;fn||(fn=noop),isSpecialMember(name)&&(name="_"+name),null!==mixin_being_applied&&attr("mixed",mixin_being_applied),meta[name]=[].concat(bucket),meta[name].type="func",meta[name].aspects=[],bucket=[];let attrs=meta[name];if(!isConditionalMemberOK(name))return void delete meta[name];if(hasAttr("override",attrs)){let desc=Object.getOwnPropertyDescriptor(_this,name);if(!desc||"function"!=typeof desc.value)throw"_constructor"===name&&(name="constructor"),"_dispose"===name&&(name="dispose"),`${className}.${name} is not a function to override.`;if(hasAttrEx("sealed",name)&&!hasAttr("sealed",attrs))throw"_constructor"===name&&(name="constructor"),"_dispose"===name&&(name="dispose"),`${className}.${name} cannot override a sealed function.`;let base=_this[name].bind(_this);Object.defineProperty(_this,name,{value:function(...args){let fnArgs=[base].concat(args);return isArrowFunction(fn)?fn(...fnArgs):fn.apply(_this,fnArgs)}.bind(_this)})}else{if(isDefined(name,!0))throw"_constructor"===name&&(name="constructor"),"_dispose"===name&&(name="dispose"),`${className}.${name} is already defined.`;Object.defineProperty(_this,name,{configurable:!0,enumerable:!0,writable:!1,value:function(...args){return isArrowFunction(fn)?fn(...args):fn.apply(_this,args)}.bind(_this)})}applyAttr(name),meta[name].ref=_this[name],meta[name].raw=fn}),_this.prop=((name,valueOrGetter,setter)=>{if(isSpecialMember(name))throw`${className}.${name} can only be defined as a function.`;"undefined"==typeof valueOrGetter&&"undefined"==typeof setter&&(valueOrGetter=null),null!==mixin_being_applied&&attr("mixed",mixin_being_applied),meta[name]=[].concat(bucket),meta[name].type="prop",meta[name].aspects=[],bucket=[];let attrs=meta[name];if(!isConditionalMemberOK(name))return void delete meta[name];if(hasAttr("override",attrs)){let desc=Object.getOwnPropertyDescriptor(_this,name);if(!desc||"function"!=typeof desc.get)throw`Not a property to override. (${className}.${name})`;if(hasAttrEx("sealed",name)&&!hasAttr("sealed",attrs))throw`Cannot override a sealed property. (${className}.${name})`;if(hasAttrEx("static",name)&&!hasAttr("static",attrs))throw`Cannot override a static property. (${className}.${name})`}else if(isDefined(name,!0))throw`${className}.${name} is already defined.`;if("function"!=typeof valueOrGetter){let propHost=null,uniqueName="",isStorageHost=!1;if(hasAttrEx("static",name)){if(uniqueName=name,hasAttrEx("session",name)||hasAttrEx("state",name))throw`A static property cannot be stored in session/state. (${className}.${name})`;propHost=staticInterface,propHost[uniqueName]||(propHost[uniqueName]=valueOrGetter)}else hasAttrEx("session",name)?(uniqueName=className+"_"+name,propHost=sessionStorage,isStorageHost=!0,"undefined"==typeof propHost[uniqueName]&&(propHost[uniqueName]=JSON.stringify({value:valueOrGetter}))):hasAttrEx("state",name)?(uniqueName=className+"_"+name,propHost=localStorage,isStorageHost=!0,"undefined"==typeof propHost[uniqueName]&&(propHost[uniqueName]=JSON.stringify({value:valueOrGetter}))):(uniqueName=name,propHost=props,propHost[uniqueName]=valueOrGetter);Object.defineProperty(_this,name,{__proto__:null,configurable:!0,enumerable:!0,get:()=>{return isStorageHost?JSON.parse(propHost[uniqueName]).value:propHost[uniqueName]},set:hasAttr("readonly",attrs)?value=>{if(!(_this._.constructing||hasAttr("once",attrs)&&!propHost[uniqueName]))throw`${name} is readonly.`;isStorageHost?propHost[uniqueName]=JSON.stringify({value:value}):propHost[uniqueName]=value}:value=>{isStorageHost?propHost[uniqueName]=JSON.stringify({value:value}):propHost[uniqueName]=value}})}else{if(hasAttr("static",attrs))throw`Static properties cannot be defined with a getter/setter. (${className}.${name})`;if(hasAttr("session",attrs)||hasAttr("state",attrs))throw`Properties defined with a getter/setter cannot be stored in session/state. (${className}.${name})`;Object.defineProperty(_this,name,{__proto__:null,configurable:!0,enumerable:!0,get:valueOrGetter,set:hasAttr("readonly",attrs)?value=>{if(!(_this._.constructing||hasAttr("once",attrs)&&!valueOrGetter()))throw`${name} is readonly.`;"function"==typeof setter&&setter(value)}:value=>{"function"==typeof setter&&setter(value)}})}applyAttr(name),meta[name].ref={get:()=>{return _this[name]},set:value=>{_this[name]=value}}}),_this.event=(name=>{if(isSpecialMember(name))throw`${className}.${name} can only be defined as a function.`;if(isDefined(name,!0))throw`${className}.${name} is already defined.`;meta[name]=[],meta[name].type="event",meta[name].aspects=[],bucket.length>0&&(console.warn(`Attributes can only be applied to properties or functions. ${className}.${name} is an event.`),bucket=[]);let _event=function(...args){let e={name:name,args:args,stop:!1};for(let handler of events)if(handler(e),e.stop)break}.bind(_this);_event.subscribe=(fn=>{events.push(fn)}),_event.subscribe.all=(()=>{return events.slice()}),_event.unsubscribe=(fn=>{let index=events.indexOf(fn);index!==-1&&events.splice(index,1)}),_event.unsubscribe.all=(()=>{events=[]}),Object.defineProperty(_this,name,{configurable:!1,enumerable:!0,value:_event,writable:!1}),meta[name].ref=_this[name]}),_this.noop=noop,_this.noopAsync=noopAsync,_this._=_this._||{},_this._.type="instance",_this._.name=className,_this._.id=guid(),_this._.instanceOf=_this._.instanceOf||[],inherits||_this._.instanceOf.push({name:"Object",type:Object,meta:[],mixins:[],interfaces:[]}),_this._.instanceOf.push({name:className,type:Class,meta:meta,mixins:mixins,interfaces:interfaces}),_this._.inherits=Class,_this._.isInstanceOf=(name=>{return _this._.instanceOf.findIndex(item=>{return item.name===name})!==-1}),_this._.raw=(name=>{return meta[name]&&meta[name].raw?meta[name].raw:null}),_this._.isMixed=(name=>{let result=!1;for(let item of _this._.instanceOf)for(let mixin of item.mixins){if(mixin._.name===name){result=!0;break}if(result)break}return result}),_this._.isImplements=(name=>{let result=!1;for(let item of _this._.instanceOf)for(let _interface of item.interfaces){if(_interface._.name===name){result=!0;break}if(result)break}return result}),_this._._={hasAttr:hasAttr,hasAttrEx:hasAttrEx,isOwnMember:isOwnMember,isDerivedMember:isDerivedMember,isProtectedMember:isProtectedMember,isSealedMember:isSealedMember,isSerializableMember:isSerializableMember},_this._.serialize=(()=>{let json={};return processJson(_this,json),json}),_this._.deserialize=(json=>{processJson(json,_this,!0)}),factory.apply(_this,[attr]),_flag!==theFlag&&isAbstractClass())throw`Cannot create instance of an abstract class. (${className})`;if(0!==mixins.length)for(let mixin of mixins)"mixin"===mixin._.type&&(mixin_being_applied=mixin,mixin.apply(_this,[attr]),mixin_being_applied=null);delete _this.func,delete _this.prop,delete _this.event,delete _this.noop,delete _this.noopAsync,weave(),isNeedProtected||("function"==typeof _this._constructor&&(_this._.constructing=!0,_this._constructor(...classArgs),_this._.constructor=this._constructor,delete _this._constructor,delete _this._.constructing),"function"==typeof _this._dispose&&(_this._._dispose=_this._dispose,delete _this._dispose));let isCopy=!1;doCopy("_");for(let member in _this)isCopy=!1,_this.hasOwnProperty(member)&&(isCopy=!0,isOwnMember(member)?(isPrivateMember(member)&&(isCopy=!1),isCopy&&isProtectedMember(member)&&!isNeedProtected&&(isCopy=!1)):(isProtectedMember(member)&&!isNeedProtected&&(isCopy=!1),isCopy&&!isDerivedMember(member)&&(isCopy=!1))),isCopy&&isHiddenMember(member)&&(isCopy=!1),isCopy&&doCopy(member);for(let member in _exposed_this)!isSpecialMember(member)&&isOwnMember(member)&&isSealedMember(member)&&Object.defineProperty(_exposed_this,member,{configurable:!1});if(0!==interfaces.length)for(let _interface of interfaces)for(let _memberName in _interface)if(_interface.hasOwnProperty(_memberName)&&"_"!==_memberName){let _member=_interface[_memberName],_type=typeof _exposed_this[_memberName];if("undefined"===_type)throw`${_interface._.name}.${_memberName} is not defined.`;switch(_member.type){case"func":if("function"!==_type)throw`${_interface._.name}.${_memberName} is not a function.`;break;case"prop":if("function"===_type)throw`${_interface._.name}.${_memberName} is not a property.`;break;case"event":if("function"!==_type||"function"!=typeof _exposed_this[_memberName].subscribe)throw`${_interface._.name}.${_memberName} is not an event.`}}return _this._.pu=isNeedProtected?null:_exposed_this,_this._.pr=isNeedProtected?null:_this,isSingletonClass()?(Class._.isSingleton=(()=>{return!0}),Class._.singleInstance=(()=>{return Object.freeze(_exposed_this)}),Class._.singleInstance.clear=(()=>{Class._.singleInstance=(()=>{return null}),Class._.isSingleton=(()=>{return!1})}),Class._.singleInstance()):isSealedMember("_constructor")?(Class._.isSealed=(()=>{return!0}),Object.freeze(_exposed_this)):_exposed_this};return Class._={inherits:inherits,mixins:mixins,interfaces:interfaces,name:className,type:"class",singleInstance:()=>{return null},isSingleton:()=>{return!1},isSealed:()=>{return!1},isDerivedFrom:name=>{let result="Object"===name,prv=inherits;if(!result)for(;;){if(null===prv)break;if(prv._.name===name){result=!0;break}prv=prv._.inherits}return result},isMixed:name=>{let result=!1;for(let mixin of mixins)if(mixin._.name===name){result=!0;break}return result},isImplements:name=>{let result=!1;for(let _interface of interfaces)if(_interface._.name===name){result=!0;break}return result},static:{}},Class._.singleInstance.clear=(()=>{}),Class}),oojs.Mixin=((mixinName,factory)=>{return factory._={name:mixinName,type:"mixin"},factory}),oojs.Interface=((interfaceName,factory)=>{let meta={},_this={};return _this.func=(name=>{if("undefined"!=typeof meta[name])throw`${interfaceName}.${name} is already defined.`;meta[name]=[],meta[name].type="func"}),_this.prop=(name=>{if("undefined"!=typeof meta[name])throw`${interfaceName}.${name} is already defined.`;meta[name]=[],meta[name].type="prop"}),_this.event=(name=>{if("undefined"!=typeof meta[name])throw`${interfaceName}.${name} is already defined.`;meta[name]=[],meta[name].type="event"}),factory.apply(_this),meta._={name:interfaceName,type:"interface"},meta}),oojs.Enum=((enumName,keyValuePairs)=>{let _enum=keyValuePairs;return _enum._={name:enumName,type:"enum",keys:()=>{let items=[];for(let key in keyValuePairs)keyValuePairs.hasOwnProperty(key)&&"_"!==key&&items.push(key);return items},values:()=>{let items=[];for(let key in keyValuePairs)keyValuePairs.hasOwnProperty(key)&&"_"!==key&&items.push(keyValuePairs[key]);return items}},Object.freeze(_enum)}),oojs.Structure=((structureName,factoryFn)=>{let _structure=factoryFn;return _structure._={name:structureName,type:"structure"},_structure}),oojs.Assembly=((asmName,nestedStructure)=>{let _asm=nestedStructure;return _asm._={name:asmName,type:"assembly"},Object.freeze(_asm)}),oojs.using=((obj,scopeFn)=>{try{scopeFn(obj)}finally{obj._&&"function"==typeof obj._.dispose&&obj._.dispose()}}),oojs.as=((obj,intf)=>{return obj._.isImplements(intf._.name)?obj:null});let allAspects={};oojs.Aspects={},oojs.Aspects.register=((pointcut,Aspect)=>{allAspects[pointcut]||(allAspects[pointcut]=[]),allAspects[pointcut].push(Aspect)}),oojs.Aspect=oojs.Class("Aspect",function(){let beforeFn=null,afterFn=null,aroundFn=null;this.func("constructor",(...args)=>{this.args=args}),this.prop("args",[]),this.func("before",fn=>{return"function"==typeof fn&&(beforeFn=fn),beforeFn}),this.func("after",fn=>{return"function"==typeof fn&&(afterFn=fn),afterFn}),this.func("around",fn=>{return"function"==typeof fn&&(aroundFn=fn),aroundFn})});let container={};if(oojs.Container={},oojs.Container.register=((typeName,cls)=>{"function"==typeof typeName&&(cls=typeName,typeName=cls._.name),container[typeName]||(container[typeName]=[]),container[typeName].push(cls)}),oojs.Container.isRegistered=(typeName=>{return"undefined"!=typeof container[typeName]}),oojs.Container.get=(typeName=>{return(container[typeName]||[]).slice()}),oojs.Container.resolve=((typeName,isMultiResolve,...args)=>{let result=null;if(container[typeName]&&container[typeName].length>0)if(isMultiResolve){result=[];for(let Type of container[typeName])result.push(new Type(...args))}else{let Type=container[typeName][0];result=new Type(...args)}return result}),oojs.Attribute=oojs.Class("Attribute",function(){let decoratorFn=null;this.func("constructor",(...args)=>{this.args=args}),this.prop("args",[]),this.func("decorator",fn=>{return"function"==typeof fn&&(decoratorFn=fn),decoratorFn}),this.func("resetEventInterface",(source,target)=>{target.subscribe=source.subscribe,target.unsubscribe=source.unsubscribe,delete source.subscribe,delete source.unsubscribe})}),oojs.Container.register(oojs.Class("async",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func"].indexOf(type)===-1)throw`async attribute cannot be applied on ${type} members. (${className}.${name})`;if(["_constructor","_dispose"].indexOf(type)!==-1)throw`async attribute cannot be applied on special function. (${className}.${name})`;let fn=descriptor.value;descriptor.value=function(...args){return new Promise((resolve,reject)=>{let fnArgs=[resolve,reject].concat(args);fn(...fnArgs)})}.bind(obj)})})),oojs.Container.register(oojs.Class("deprecate",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["_constructor","_dispose"].indexOf(type)!==-1)throw`deprecate attribute cannot be applied on special function. (${className}.${name})`;let msg=`${name} is deprecated.`;switch("undefined"!=typeof this.args[0]&&(msg+=" "+this.args[0]),type){case"prop":if(descriptor.get){let _get=descriptor.get;descriptor.get=function(){return console.warn(msg),_get()}.bind(obj)}if(descriptor.set){let _set=descriptor.set;descriptor.set=function(value){return console.warn(msg),_set(value)}.bind(obj)}break;case"func":let fn=descriptor.value;descriptor.value=function(...args){console.warn(msg),fn(...args)}.bind(obj);break;case"event":let ev=descriptor.value;descriptor.value=function(...args){console.warn(msg),ev(...args)}.bind(obj),this.resetEventInterface(fn,descriptor.value)}})})),oojs.Container.register(oojs.Class("enumerate",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["_constructor","_dispose"].indexOf(type)!==-1)throw`enumerate attribute cannot be applied on special function. (${className}.${name})`;let flag=this.args[0];descriptor.enumerable=flag})})),oojs.Container.register(oojs.Class("inject",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func","prop"].indexOf(type)===-1)throw`inject attribute cannot be applied on ${type} members. (${className}.${name})`;if(["_constructor","_dispose"].indexOf(name)!==-1)throw`inject attribute cannot be applied on special function. (${className}.${name})`;let Type=this.args[0],typeArgs=this.args[1],instance=null;if(Array.isArray(typeArgs)||(typeArgs=[typeArgs]),"string"==typeof Type){if(Type.indexOf("|")!==-1){let items=Type.split("|");Type="server"===options.env?items[0].trim():items[1].trim()}instance=oojs.Container.resolve(Type,!1,...typeArgs)}else instance=new Type(...typeArgs);switch(type){case"func":let fn=descriptor.value;descriptor.value=function(...args){fn(instance,...args)}.bind(obj);break;case"prop":obj[name]=instance}})})),oojs.Container.register(oojs.Class("multiinject",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func","prop"].indexOf(type)===-1)throw`multiinject attribute cannot be applied on ${type} members. (${className}.${name})`;if(["_constructor","_dispose"].indexOf(name)!==-1)throw`multiinject attribute cannot be applied on special function. (${className}.${name})`;let Type=this.args[0],typeArgs=this.args[1],instance=null;if(Array.isArray(typeArgs)||(typeArgs=[typeArgs]),"string"!=typeof Type)throw`multiinject attribute does not support direct type injections. (${className}.${name})`;if(Type.indexOf("|")!==-1){let items=Type.split("|");Type="server"===options.env?items[0].trim():items[1].trim()}switch(instance=oojs.Container.resolve(Type,!0,...typeArgs),type){case"func":let fn=descriptor.value;descriptor.value=function(...args){fn(instance,...args)}.bind(obj);break;case"prop":obj[name]=instance}})})),oojs.Serializer={},oojs.Serializer.serialize=(instance=>{return instance._.serialize()}),oojs.Serializer.deserialize=((Type,json)=>{let instance=new Type;return instance._.deserialize(json),instance}),oojs.Reflector={},oojs.Reflector.get=(forTarget=>{const CommonTypeReflector=function(target){this.getType=(()=>{return target._.type}),this.getName=(()=>{return target._.name||""}),this.getTarget=(()=>{return target})},CommonMemberReflector=function(type,target,name){this.getType=(()=>{return"member"}),this.getMemberType=(()=>{return type}),this.getTarget=(()=>{return target}),this.getTargetType=(()=>{return target._.type}),this.getName=(()=>{return name})},AttrReflector=function(Attr,name,args,target){this.getType=(()=>{return"attribute"}),this.getName=(()=>{return name}),this.getTarget=(()=>{return target}),this.getArgs=(()=>{return args.slice()}),this.getClass=(()=>{return Attr?new ClassReflector(Attr):null})},AspectReflector=function(Aspect,target){this.getType=(()=>{return"aspect"}),this.getName=(()=>{return Aspect._.name}),this.getTarget=(()=>{return target}),this.getClass=(()=>{return Aspect?new ClassReflector(Aspect):null})},CommonInstanceMemberReflector=function(type,target,name,ref){let refl=new CommonMemberReflector(type,target,name);return refl.getAttributes=(()=>{let items=[],attrs=[];for(let item of target._.instanceOf)if(item.meta[name]){attrs=item.meta[name];for(let attr of attrs)items.push(new AttrReflector(attr.Attr,attr.name,attr.args,target))}return items}),refl.hasAttribute=(attrName=>{let isOk=!1,attrs=[];for(let item of target._.instanceOf){if(item.meta[name]){attrs=item.meta[name];for(let attr of attrs)if(attr.name==attrName){isOk=!0;break}}if(isOk)break}return isOk}),refl.getAttribute=(attrName=>{let attrInfo=null;for(let item of target._.instanceOf){if(item.meta[name]){attrs=item.meta[name];for(let attr of attrs)if(attr.name===attrName){attrInfo=new AttrReflector(attr.Attr,attr.name,attr.args,target);break}}if(null!==attrInfo)break}return attrInfo}),refl.isEnumerable=(()=>{return!!target[name]&&Object.getOwnPropertyDescriptor(target,name).enumerable}),refl.isDeprecated=(()=>{return target._._.hasAttrEx("deprecate",name)}),refl.isConditional=(()=>{return target._._.hasAttrEx("conditional",name)}),refl.isOverridden=(()=>{return target._._.hasAttrEx("override",name)}),refl.isOwn=(()=>{return target._.isOwnMember(name)}),refl.isDerived=(()=>{return target._._.isDerivedMember(name)}),refl.isPrivate=(()=>{return target._._.hasAttrEx("private",name)}),refl.isProtected=(()=>{return target._._.isProtectedMember(name)}),refl.isPublic=(()=>{return!refl.isPrivate&&!refl.isProtected}),refl.isSealed=(()=>{return target._._.isSealedMember(name)}),refl.isMixed=(()=>{return target._._.hasAttrEx("mixed",name)}),refl.getMixin=(()=>{if(refl.isMixed()){let mixin=refl.getAttribute("mixed").getArgs()[0];return new MixinReflector(mixin)}return null}),refl},PropReflector=function(target,name,ref){let refl=new CommonInstanceMemberReflector("prop",target,name,ref);return refl.getValue=(()=>{return ref.get()}),refl.setValue=(value=>{return ref.set(value)}),refl.isReadOnly=(()=>{return target._._.hasAttrEx("readonly",name)}),refl.isSetOnce=(()=>{return target._._.hasAttrEx("readonly",name)&&target._._.hasAttrEx("once",name)}),refl.isStatic=(()=>{return target._._.hasAttrEx("static",name)}),refl.isSerializable=(()=>{return target._._.isSerializableMember(name)}),refl},FuncReflector=function(target,name,ref,raw){let refl=new CommonInstanceMemberReflector("func",target,name,ref);return refl.invoke=((...args)=>{return ref(...args)}),refl.getAspects=(()=>{let items=[],aspects=[];for(let item of target._.instanceOf)if(item.meta[name]){aspects=item.meta[name].aspects;for(let aspect of aspects)items.push(new AspectReflector(aspect,target))}return items}),refl.getRaw=(()=>{return raw}),refl.isASync=(()=>{return target._._.hasAttrEx("async",name)}),refl.isConstructor=(()=>{return"_constructor"===name}),refl.isDisposer=(()=>{return"_dispose"===name}),refl},EventReflector=function(target,name,ref){let refl=new CommonInstanceMemberReflector("event",target,name,ref);return refl.raise=((...args)=>{return ref(...args)}),refl.isSubscribed=(()=>{return ref.subscribe.all().length>0}),refl},KeyReflector=function(target,name){let refl=new CommonMemberReflector("key",target,name);return refl.getValue=(()=>{return target[name]}),refl},AsmMemberReflector=function(target,name,member){let refl=new CommonMemberReflector(member._.type,target,name);return refl.getMember=(()=>{return oojs.Reflector.get(member)}),refl},InstanceReflector=function(target){let refl=new CommonTypeReflector(target),filterMembers=(members,type,attrs)=>{if(""===type&&0===attrs.length)return members.slice();let filtered=[],hasAllAttrs=!0;for(let member of members)if("member"===member.getType()&&(""===type||member.getMemberType()===type)){if(hasAllAttrs=!0,0!==attrs.length)for(let attrName of attrs)if(!member.hasAttribute(attrName)){hasAllAttrs=!1;break}hasAllAttrs&&filtered.push(member)}return filtered};return getMembers=(oneMember=>{let members=[],attrs=[],lastMember=null,member=null;for(let instance of target._.instanceOf){for(let name in instance.meta){if(instance.meta.hasOwnProperty(name)){switch(attrs=instance.meta[name],instance.meta[name].type){case"func":lastMember=new FuncReflector(target,name,instance.meta[name].ref,instance.meta[name].raw),members.push(lastMember);break;case"prop":lastMember=new PropReflector(target,name,instance.meta[name].ref),members.push(lastMember);break;case"event":lastMember=new EventReflector(target,name,instance.meta[name].ref),members.push(lastMember);break;default:throw"Unknown member type"}"undefined"!=typeof oneMember&&name===oneMember&&(members=[],member=lastMember)}if(null!==member)break}if(null!==member)break}return null!==member?member:{all:(...attrs)=>{return filterMembers(members,"",attrs)},func:(...attrs)=>{return filterMembers(members,"func",attrs)},prop:(...attrs)=>{return filterMembers(members,"prop",attrs)},event:(...attrs)=>{return filterMembers(members,"event",attrs)}}}),refl.getClass=(()=>{return null!==target._.inherits?new ClassReflector(target._.inherits):null}),refl.getFamily=(()=>{let items=[],prv=target._.inherits;for(;;){if(null===prv)break;items.push(new ClassReflector(prv)),prv=prv._.inherits}return items}),refl.getMixins=(()=>{let items=[],family=refl.getFamily();for(let cls of family)items=items.concat(cls.getMixins());return items}),refl.getInterfaces=(()=>{let items=[],family=refl.getFamily();for(let cls of family)items=items.concat(cls.getInterfaces());return items}),refl.getMembers=(()=>{return getMembers()}),refl.getMember=(name=>{return getMembers(name)}),refl.isSingleton=(()=>{return refl.getClass().isSingleton()}),refl.isInstanceOf=(name=>{return target._.isInstanceOf(name)}),refl.isMixed=(name=>{return target._.isMixed(name)}),refl.isImplements=(name=>{return target._.isImplements(name)}),refl},ClassReflector=function(target){let refl=new CommonTypeReflector(target);return refl.getParent=(()=>{return null!==target._.inherits?new ClassReflector(target._.inherits):null}),refl.getFamily=(()=>{let items=[],prv=target._.inherits;for(;;){if(null===prv)break;items.push(new ClassReflector(prv)),prv=prv._.inherits}return items}),refl.getMixins=(()=>{let items=[];for(let mixin of target._.mixins)items.push(new MixinReflector(mixin));return items}),refl.getInterfaces=(()=>{let items=[];for(let _interface of target._.interfaces)items.push(new InterfaceReflector(_interface));return items}),refl.isSingleton=(()=>{return target._.isSingleton()}),refl.isSingleInstanceCreated=(()=>{return null!==target._.singleInstance()}),refl.isSealed=(()=>{return target._.isSealed()}),refl.isDerivedFrom=(name=>{return target._.isDerivedFrom(name)}),refl.isMixed=(name=>{return target._.isMixed(name)}),refl.isImplements=(name=>{return target._.isImplements(name)}),refl},EnumReflector=function(target){
let refl=new CommonTypeReflector(target);return refl.getMembers=(()=>{let keys=target._.keys(),members=[];for(let key of keys)members.push(new KeyReflector(target,key));return members}),refl.getMember=(name=>{if("undefined"==typeof target[name])throw`${name} is not defined.`;return new KeyReflector(target,name)}),refl.getKeys=(()=>{return target._.keys()}),refl.getValues=(()=>{return target._.values()}),refl},StructureReflector=function(target){let refl=new CommonTypeReflector(target);return refl},AssemblyReflector=function(target){let refl=new CommonTypeReflector(target);return refl.getMembers=(()=>{let members=[];const findMembers=(obj,ns)=>{for(let key in obj)obj.hasOwnProperty(key)&&"_"!==key&&("undefined"==typeof obj[key]._?findMembers(obj[key],ns+"."+key):members.push(new AsmMemberReflector(target,ns+"."+obj[key]._.name,obj[key])))};return findMembers(target,target._.name),members}),refl.getMember=(qualifiedName=>{let items=qualifiedName.split(".");if(items.length>0&&(items.shift(),qualifiedName=items.join(".")),"undefined"==typeof target[qualifiedName])throw`${qualifiedName} is not defined.`;return oojs.Reflector.get(target[qualifiedName])}),refl},MixinReflector=function(target){let refl=new CommonTypeReflector(target);return refl},InterfaceReflector=function(target){let refl=new CommonTypeReflector(target),getMembers=()=>{let members=[];for(let _memberName in target)target.hasOwnProperty(_memberName)&&"_"!==_memberName&&members.push(new CommonMemberReflector(target[_memberName].type,target,_memberName));return members};return refl.getMembers=(()=>{return getMembers()}),refl.getMember=(name=>{if("undefined"==typeof target[name])throw`${name} is not defined.`;return new CommonMemberReflector(target[name].type,target,name)}),refl};let ref=null;switch(forTarget._.type){case"instance":ref=new InstanceReflector(forTarget);break;case"class":ref=new ClassReflector(forTarget);break;case"enum":ref=new EnumReflector(forTarget);break;case"structure":ref=new StructureReflector(forTarget);break;case"assembly":ref=new AssemblyReflector(forTarget);break;case"mixin":ref=new MixinReflector(forTarget);break;case"interface":ref=new InterfaceReflector(forTarget);break;default:throw"Unknown type"}return ref}),!options.supressGlobals){let g=options.global;g.Class=oojs.Class,g.Mixin=oojs.Mixin,g.Interface=oojs.Interface,g.Structure=oojs.Structure,g.Enum=oojs.Enum,g.Assembly=oojs.Assembly,g.Attribute=oojs.Attribute,g.Aspect=oojs.Aspect,g.Aspects=oojs.Aspects,g.Container=oojs.Container,g.Serializer=oojs.Serializer,g.Reflector=oojs.Reflector,g.using=oojs.using,g.as=oojs.as}return Object.freeze(oojs)};"object"==typeof("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=def:"function"==typeof define&&"undefined"!=typeof define.amd?define(function(){return def}):this.oojs=def}).call(this);